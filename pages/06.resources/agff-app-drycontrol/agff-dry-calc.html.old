<!DOCTYPE html>
<html lang="de"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGFF Heutrocknungsrechner Pro</title>
    <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 24 24&#39; fill=&#39;none&#39; stroke=&#39;%233b82f6&#39; stroke-width=&#39;2&#39; stroke-linecap=&#39;round&#39; stroke-linejoin=&#39;round&#39;&gt;&lt;path d=&#39;M17.7 17.7A2.5 2.5 0 1 0 21 15H4M6.3 6.3A2.5 2.5 0 1 0 3 9H20&#39;/&gt;&lt;path d=&#39;M12 12H2&#39;/&gt;&lt;/svg&gt;">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        input[type=number] { -moz-appearance: textfield; appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        input:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .disabled-group { opacity: 0.6; pointer-events: none; filter: grayscale(100%); }
        
        /* Smooth Accordion */
        .accordion-content { transition: max-height 0.3s ease-in-out; }
        
        /* Custom Slider Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid currentColor;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: #cbd5e1; border-radius: 4px;
        }

        /* Ampel Styles */
        .ampel-box { transition: all 0.3s ease; opacity: 0.4; transform: scale(0.95); border: 1px solid transparent; }
        .ampel-box.active { opacity: 1; transform: scale(1.0); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-width: 2px; }
        
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 p-4 md:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto"> 
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 flex items-center gap-3 tracking-tight">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="wind" class="lucide lucide-wind text-blue-600 w-10 h-10"><path d="M12.8 19.6A2 2 0 1 0 14 16H2"></path><path d="M17.5 8a2.5 2.5 0 1 1 2 4H2"></path><path d="M9.8 4.4A2 2 0 1 1 11 8H2"></path></svg>
                    Heutrocknungs-Planer
                </h1>
                <p class="text-slate-500 mt-2 text-lg">Simulation von Aufbereitung, Wasserentzug &amp; Trocknungsstrategie</p>
            </div>
            <div class="flex gap-6 text-sm text-slate-600 bg-white px-6 py-3 rounded-xl shadow-sm border border-slate-200">
                 <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="gauge" class="lucide lucide-gauge h-5 w-5 text-slate-400"><path d="m12 14 4-4"></path><path d="M3.34 19a10 10 0 1 1 17.32 0"></path></svg>
                    <span id="altitude-display" class="font-medium">600 m</span>
                 </div>
                 <div class="w-px h-5 bg-slate-200"></div>
                 <div class="font-medium" id="pressure-display">943 hPa</div>
                 <div class="w-px h-5 bg-slate-200"></div>
                 <div class="font-medium" id="density-display">1.12 kg/m³</div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden group hover:shadow-md transition-shadow duration-300">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center">
                        <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> 1. Aussenluft (Start)</span>
                        <button id="camera-scan-btn" class="text-slate-400 hover:text-blue-600 transition-colors bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm" title="Wetterdaten holen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="camera" class="lucide lucide-camera h-4 w-4"><path d="M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="thermometer" class="lucide lucide-thermometer h-5 w-5 text-blue-400"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path></svg> Temperatur
                                </label>
                                <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="tIn-text" min="-10" max="45" step="0.5" value="20.0" class="w-24 text-right font-bold text-slate-900 bg-transparent py-2 px-3 focus:outline-none focus:bg-white transition-colors">
                                    <span class="text-slate-500 font-normal pr-3">°C</span>
                                </div>
                            </div>
                            <input type="range" id="tIn-slider" min="-10" max="45" step="0.5" value="20" class="w-full text-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="droplets" class="lucide lucide-droplets h-5 w-5 text-blue-400"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"></path></svg> Rel. Feuchte
                                </label>
                                <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="hIn-text" min="10" max="100" step="1" value="60" class="w-24 text-right font-bold text-slate-900 bg-transparent py-2 px-3 focus:outline-none focus:bg-white transition-colors">
                                    <span class="text-slate-500 font-normal pr-3">%</span>
                                 </div>
                            </div>
                            <input type="range" id="hIn-slider" min="10" max="100" step="1" value="60" class="w-full text-blue-500">
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <button id="fetch-weather-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 text-sm font-medium rounded-lg hover:bg-blue-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="map-pin" class="lucide lucide-map-pin h-4 w-4"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg> Lokales Wetter laden
                            </button>
                            <span id="weather-status-message" class="block text-center text-xs text-slate-400 mt-1 h-4"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-amber-50 rounded-2xl shadow-sm border border-amber-100 overflow-hidden relative group hover:shadow-md transition-shadow duration-300">
                    <div class="absolute right-0 top-0 p-4 opacity-5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="sun" class="lucide lucide-sun h-32 w-32"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                    </div>
                    <div class="bg-amber-100/60 px-6 py-4 border-b border-amber-200 font-semibold text-amber-900 flex justify-between items-center">
                        <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-500"></div> 2. Aufbereitung</span>
                    </div>
                    <div class="p-6 relative z-10">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-amber-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="zap" class="lucide lucide-zap h-5 w-5 text-amber-600"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"></path></svg> Anwärmung (+ΔT)
                                </label>
                                <div class="flex items-center gap-2 bg-white border border-amber-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="sim-heat-text" min="0" max="30" step="0.5" value="0.0" class="w-24 text-right font-bold text-amber-900 bg-transparent py-2 px-3 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <span class="text-amber-700 font-normal pr-3">°C</span>
                                </div>
                            </div>
                            <input type="range" id="sim-heat-slider" min="0" max="30" step="0.5" value="0" class="w-full text-amber-600 accent-amber-600">
                        </div>

                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-amber-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="droplet-off" class="lucide lucide-droplet-off h-5 w-5 text-blue-600"><path d="M18.715 13.186C18.29 11.858 17.384 10.607 16 9.5c-2-1.6-3.5-4-4-6.5a10.7 10.7 0 0 1-.884 2.586"></path><path d="m2 2 20 20"></path><path d="M8.795 8.797A11 11 0 0 1 8 9.5C6 11.1 5 13 5 15a7 7 0 0 0 13.222 3.208"></path></svg> Entfeuchter (-Δx)
                                </label>
                                <div class="flex items-center gap-2 bg-white border border-amber-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="sim-dry-text" min="0" max="10" step="0.1" value="0.0" class="w-24 text-right font-bold text-amber-900 bg-transparent py-2 px-3 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <span class="text-amber-700 font-normal pr-3">g/kg</span>
                                </div>
                            </div>
                            <input type="range" id="sim-dry-slider" min="0" max="10" step="0.1" value="0" class="w-full text-blue-600 accent-blue-600">
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-amber-200 grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs uppercase font-bold text-amber-800 tracking-wider">Vor Stock</span>
                                <div class="font-bold text-xl text-amber-900 mt-1"><span id="res-cond-temp">20.0</span>°C</div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs uppercase font-bold text-amber-800 tracking-wider">Luftfeuchte</span>
                                <div class="font-bold text-xl text-amber-900 mt-1"><span id="res-cond-rh">60</span>% <span class="text-sm font-normal text-amber-700">rF</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden group hover:shadow-md transition-shadow duration-300">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center">
                        <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> 3. Abluft (Stock-Austritt)</span>
                        
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-full border border-slate-200 shadow-sm">
                            <label for="checkAdiabat" class="text-xs font-medium text-slate-600 cursor-pointer select-none pl-1">Adiabatisch</label>
                            <input type="checkbox" id="checkAdiabat" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                        </div>
                    </div>
                    <div class="p-6 relative">
                        <div id="sync-indicator" class="absolute top-2 right-6 text-[10px] text-blue-500 font-semibold uppercase tracking-wider bg-blue-50 px-2 py-1 rounded hidden">Auto-Sync</div>

                        <div class="mb-6" id="tOut-container">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="thermometer" class="lucide lucide-thermometer h-5 w-5 text-red-400"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path></svg> Temperatur
                                </label>
                                <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="tOut-text" min="0" max="50" step="0.1" value="20.0" class="w-24 text-right font-bold text-slate-900 bg-transparent py-2 px-3 focus:outline-none focus:bg-white transition-colors">
                                    <span class="text-slate-500 font-normal pr-3">°C</span>
                                </div>
                            </div>
                            <input type="range" id="tOut-slider" min="0" max="50" step="0.1" value="20" class="w-full text-red-400 accent-red-500">
                        </div>

                        <div class="mb-2">
                            <div class="flex justify-between items-center mb-3">
                                <label class="flex items-center gap-2 font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="droplets" class="lucide lucide-droplets h-5 w-5 text-blue-400"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"></path></svg> Rel. Feuchte
                                </label>
                                <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg shadow-inner overflow-hidden">
                                    <input type="number" id="hOut-text" min="10" max="100" step="1" value="60" class="w-24 text-right font-bold text-slate-900 bg-transparent py-2 px-3 focus:outline-none focus:bg-white transition-colors">
                                    <span class="text-slate-500 font-normal pr-3">%</span>
                                </div>
                            </div>
                            <input type="range" id="hOut-slider" min="10" max="100" step="1" value="60" class="w-full text-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button id="params-toggle" class="w-full bg-slate-50 px-6 py-4 border-b border-slate-100 font-medium text-slate-700 flex justify-between items-center hover:bg-slate-100 transition-colors">
                        <span class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="sliders" class="lucide lucide-sliders w-4 h-4"><path d="M10 8h4"></path><path d="M12 21v-9"></path><path d="M12 8V3"></path><path d="M17 16h4"></path><path d="M19 12V3"></path><path d="M19 21v-5"></path><path d="M3 14h4"></path><path d="M5 10V3"></path><path d="M5 21v-7"></path></svg> 4. Anlagenparameter</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="chevron-down" id="params-icon" class="lucide lucide-chevron-down h-4 w-4 text-slate-400 transform transition-transform duration-300"><path d="m6 9 6 6 6-6"></path></svg>
                    </button>
                    
                    <div id="params-content" class="hidden p-6 bg-slate-50/50 border-t border-slate-100">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="mountain" class="lucide lucide-mountain h-4 w-4 text-slate-500"><path d="m8 3 4 8 5-5 5 15H2L8 3z"></path></svg> Höhe über Meer
                                </label>
                                <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <input type="number" id="altitude-text" value="600" step="10" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">m</span>
                                </div>
                            </div>
                            <input type="range" id="altitude-slider" min="0" max="2500" step="10" value="600" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-400">
                        </div>
                        
                        <div class="mb-1">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="wind" class="lucide lucide-wind h-4 w-4 text-slate-500"><path d="M12.8 19.6A2 2 0 1 0 14 16H2"></path><path d="M17.5 8a2.5 2.5 0 1 1 2 4H2"></path><path d="M9.8 4.4A2 2 0 1 1 11 8H2"></path></svg> Luftmenge
                                </label>
                                <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <input type="number" id="flowRate-text" value="10.0" step="0.5" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">m³/s</span>
                                </div>
                            </div>
                            <input type="range" id="flowRate-slider" min="0" max="100" step="0.5" value="10.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-400">
                        </div>
                    </div>
                </div>

            </div> 

            <div id="results-column" class="lg:col-span-8 space-y-6">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden flex flex-col justify-between">
                        <div class="absolute top-0 right-0 p-4 opacity-5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="droplets" class="lucide lucide-droplets w-20 h-20 text-blue-900"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"></path></svg>
                        </div>
                        <div class="text-slate-500 text-xs uppercase font-bold tracking-wider mb-2">Wasserentzug pro Kubikmeter</div>
                        <div class="flex items-baseline gap-2 mt-2">
                             <span id="water-m3-big" class="text-5xl font-extrabold text-blue-600">0.00</span>
                             <div class="flex flex-col">
                                 <span class="text-xl font-bold text-slate-700">g/m³</span>
                                 <span class="text-xs text-slate-400 font-medium">bei aktueller Dichte</span>
                             </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                            <div class="text-sm text-slate-500">Gesamtleistung:</div>
                            <div class="font-bold text-slate-800 text-lg"><span id="water-h">0.0</span> kg/h</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden flex flex-col justify-between">
                        <div class="absolute top-0 right-0 p-4 opacity-5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="wheat" class="lucide lucide-wheat w-20 h-20 text-emerald-900"><path d="M2 22 16 8"></path><path d="M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"></path><path d="M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"></path><path d="M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"></path><path d="M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z"></path><path d="M11.47 17.47 13 19l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L5 19l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"></path><path d="M15.47 13.47 17 15l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L9 15l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"></path><path d="M19.47 9.47 21 11l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L13 11l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"></path></svg>
                        </div>
                        <div class="text-slate-500 text-xs uppercase font-bold tracking-wider mb-2">Heu Status (Prognose)</div>
                        <div class="flex items-baseline gap-2 mt-2">
                             <span id="tm-value" class="text-5xl font-extrabold text-emerald-600">86.5</span>
                             <span class="text-xl font-bold text-slate-700">% TS</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3 mt-5 overflow-hidden">
                            <div id="tm-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: 73%;"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div id="status-start" class="ampel-box rounded-xl p-4 flex flex-col items-center text-center">
                        <div id="status-start-icon-bg" class="p-2 mb-2 rounded-full">
                             <svg id="status-start-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-6 h-6"></svg>
                        </div>
                        <div id="status-start-title" class="font-bold"></div>
                        <div id="status-start-text" class="text-xs mt-1 leading-tight"></div>
                    </div>

                    <div id="status-mid" class="ampel-box rounded-xl p-4 bg-yellow-50 border-yellow-200 flex flex-col items-center text-center">
                        <div class="p-2 mb-2 bg-yellow-100 rounded-full text-yellow-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-fan w-6 h-6"><path d="M12 12a3 3 0 0 0 0-6 3 3 0 0 0 0 6Z"></path><path d="M12 12a3 3 0 0 1 0 6 3 3 0 0 1 0-6Z"></path><path d="M19.07 4.93 17.66 6.34"></path><path d="M19.07 19.07 17.66 17.66"></path><path d="M4.93 19.07 6.34 17.66"></path><path d="M4.93 4.93 6.34 6.34"></path></svg>
                        </div>
                        <div class="font-bold text-yellow-800">Intervall / Endphase</div>
                        <div class="text-xs text-yellow-700 mt-1 leading-tight">Geringer Entzug. Ideal zum Kühlen oder Fertigtrocknen.</div>
                    </div>

                    <div id="status-good" class="ampel-box rounded-xl p-4 bg-emerald-50 border-emerald-200 flex flex-col items-center text-center">
                         <div class="p-2 mb-2 bg-emerald-100 rounded-full text-emerald-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2 w-6 h-6"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>
                        </div>
                        <div class="font-bold text-emerald-800">Gute Trocknung</div>
                        <div class="text-xs text-emerald-700 mt-1 leading-tight">Hoher Wasserentzug. Abluft trocken (< 65%).</div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 font-medium text-slate-700 flex justify-between items-center">
                        <span class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="line-chart" class="lucide lucide-line-chart w-4 h-4"><path d="M3 3v16a2 2 0 0 0 2 2h16"></path><path d="m19 9-5 5-4-4-3 3"></path></svg> Trocknungspfad (h-x)</span>
                        <div class="flex gap-4 text-xs font-medium">
                            <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow-sm"></div> Aussen</div>
                            <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-amber-500 shadow-sm"></div> Eintritt</div>
                            <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-sm"></div> Austritt</div>
                        </div>
                    </div>
                    <div class="p-4 flex-grow relative">
                        <canvas id="absFeuchteChart" width="808" height="600" style="display: block; box-sizing: border-box;"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 font-medium text-slate-700 flex justify-between items-center">
                         <span class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="clipboard-list" class="lucide lucide-clipboard-list w-4 h-4"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg> Protokoll</span>
                         <div class="space-x-2">
                             <button id="save-measurement-btn" class="text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1.5 rounded-lg hover:bg-emerald-100 transition-colors">Speichern</button>
                             <button id="clear-history-btn" class="text-xs font-semibold bg-red-50 text-red-700 border border-red-200 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-colors">Löschen</button>
                         </div>
                    </div>
                    <div class="p-6">
                        <div class="h-48 w-full">
                            <canvas id="historyChart" width="792" height="192" style="display: block; box-sizing: border-box;"></canvas>
                        </div>
                    </div>
                </div>

            </div> 
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {

        // --- CHART PLUGIN REGISTRATION ---
        Chart.register(ChartDataLabels);

        // --- HILFSFUNKTIONEN & PHYSIK ---
        const getSatVapPressure = (temp) => {
            if (temp >= 0) return 6.1078 * Math.exp((17.08085 * temp) / (234.175 + temp));
            return 6.1078 * Math.exp((17.84362 * temp) / (245.425 + temp));
        };
        const getAirPressure = (altitude) => 1013.25 * Math.pow(1 - 2.25577e-5 * altitude, 5.25588);
        
        const getAbsHumidity = (temp, relHum, pressure) => {
            const satPress = getSatVapPressure(temp);
            const vapPress = satPress * (relHum / 100);
            return (622 * vapPress) / (pressure - vapPress); // g/kg
        };

        const getRelHumidity = (temp, absHum_g_kg, pressure) => {
             const satPress = getSatVapPressure(temp);
             const vapPress = (absHum_g_kg * pressure) / (622 + absHum_g_kg);
             let rh = (vapPress / satPress) * 100;
             return Math.max(0, Math.min(100, rh));
        };

        const getAirDensity = (temp, pressure) => { 
            const gasConstantDryAir = 287.05;
            const tempK = temp + 273.15;
            return (pressure * 100) / (gasConstantDryAir * tempK); // kg/m3
        };

        const getEnthalpy = (temp, x) => {
            return (1.006 * temp) + (x * (2501 + 1.86 * temp) / 1000);
        }

        const solveTempForEnthalpy = (hZiel, rhZiel, pressure) => {
            let tMin = -20; let tMax = 100; let tMid = 0;
            for(let i=0; i<20; i++) {
                tMid = (tMin + tMax) / 2;
                let x = getAbsHumidity(tMid, rhZiel, pressure);
                let hCurr = getEnthalpy(tMid, x);
                if(hCurr < hZiel) tMin = tMid; else tMax = tMid;
            }
            return tMid;
        }

        const estimateTM = (hOut) => {
            const points = [
                {rh: 30, tm: 92}, {rh: 40, tm: 89}, {rh: 50, tm: 88},
                {rh: 60, tm: 86.5}, {rh: 70, tm: 82}, {rh: 80, tm: 74},
                {rh: 90, tm: 62}, {rh: 98, tm: 40}
            ];
            if (hOut <= points[0].rh) return points[0].tm.toFixed(1); 
            if (hOut >= points[points.length - 1].rh) return points[points.length - 1].tm.toFixed(1); 
            let p1, p2;
            for (let i = 0; i < points.length - 1; i++) {
                if (hOut >= points[i].rh && hOut < points[i+1].rh) { 
                    p1 = points[i]; p2 = points[i+1]; break; 
                }
            }
            const res = p1.tm + (hOut - p1.rh) * (p2.tm - p1.tm) / (p2.rh - p1.rh);
            return res.toFixed(1);
        };

        const generateRelHumidityCurve = (relHum, minTemp, maxTemp, pressure) => {
            const curve = [];
            for (let t = minTemp; t <= maxTemp; t += 1) { 
                const absHum_g_kg = getAbsHumidity(t, relHum, pressure);
                curve.push({ x: t, y: absHum_g_kg });
            }
            return curve;
        };

        // --- DOM ELEMENTE ---
        const inputs = {
            tIn: { slider: document.getElementById('tIn-slider'), text: document.getElementById('tIn-text') },
            hIn: { slider: document.getElementById('hIn-slider'), text: document.getElementById('hIn-text') },
            simHeat: { slider: document.getElementById('sim-heat-slider'), text: document.getElementById('sim-heat-text') },
            simDry: { slider: document.getElementById('sim-dry-slider'), text: document.getElementById('sim-dry-text') },
            tOut: { slider: document.getElementById('tOut-slider'), text: document.getElementById('tOut-text') },
            hOut: { slider: document.getElementById('hOut-slider'), text: document.getElementById('hOut-text') },
            altitude: { slider: document.getElementById('altitude-slider'), text: document.getElementById('altitude-text') },
            flowRate: { slider: document.getElementById('flowRate-slider'), text: document.getElementById('flowRate-text') },
            checkAdiabat: document.getElementById('checkAdiabat')
        };

        const outputs = {
            resCondTemp: document.getElementById('res-cond-temp'),
            resCondRh: document.getElementById('res-cond-rh'),
            waterH: document.getElementById('water-h'),
            waterM3Big: document.getElementById('water-m3-big'), 
            tmValue: document.getElementById('tm-value'),
            tmBar: document.getElementById('tm-bar'),
            // AMPEL DOM ELEMENTS
            ampelStart: document.getElementById('status-start'),
            ampelStartIcon: document.getElementById('status-start-icon'),
            ampelStartIconBg: document.getElementById('status-start-icon-bg'),
            ampelStartTitle: document.getElementById('status-start-title'),
            ampelStartText: document.getElementById('status-start-text'),
            ampelMid: document.getElementById('status-mid'),
            ampelGood: document.getElementById('status-good'),
            syncIndicator: document.getElementById('sync-indicator'),
            tOutContainer: document.getElementById('tOut-container'),
            headerInfo: {
                alt: document.getElementById('altitude-display'),
                press: document.getElementById('pressure-display'),
                dens: document.getElementById('density-display')
            }
        };

        // UI Logic
        const paramsToggle = document.getElementById('params-toggle');
        const paramsContent = document.getElementById('params-content');
        const paramsIcon = document.getElementById('params-icon');

        paramsToggle.addEventListener('click', () => {
            paramsContent.classList.toggle('hidden');
            if (paramsContent.classList.contains('hidden')) {
                paramsIcon.style.transform = 'rotate(0deg)';
            } else {
                paramsIcon.style.transform = 'rotate(180deg)';
            }
        });

        // --- CHART SETUP ---
        const ctx = document.getElementById('absFeuchteChart').getContext('2d');
        const absFeuchteChart = new Chart(ctx, {
            type: 'line', 
            data: {
                datasets: [
                    ...[100, 90, 80, 70, 60, 50, 40, 30, 20, 10].map((rh, i) => ({
                        label: rh + '%', data: [], 
                        borderColor: rh === 100 ? 'rgba(59, 130, 246, 0.3)' : 'rgba(148, 163, 184, 0.2)',
                        borderWidth: rh === 100 ? 2 : 1, pointRadius: 0, fill: false, tension: 0.3
                    })),
                    {
                        label: 'Prozess', data: [], pointBackgroundColor: ['#3b82f6', '#f59e0b', '#10b981'],
                        pointBorderColor: '#fff', pointRadius: 8, showLine: false
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { right: 30 } },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const labels = ['1. Aussenluft', '2. Stock-Eintritt', '3. Stock-Austritt'];
                                const p = ctx.raw;
                                return `${labels[ctx.dataIndex] || ''}: ${p.x.toFixed(1)}°C, ${p.rh.toFixed(0)}% rF, ${p.y.toFixed(1)} g/kg`;
                            }
                        }
                    },
                    datalabels: {
                        display: function(context) { return context.datasetIndex < 10 && context.dataIndex === context.dataset.data.length - 1; },
                        align: 'right', anchor: 'end', backgroundColor: 'rgba(241, 245, 249, 0.8)', borderRadius: 4,
                        color: '#64748b', font: { size: 10, weight: 'bold' }, formatter: (value, context) => context.dataset.label
                    },
                    annotation: {
                        annotations: {
                            arrow1: { type: 'line', borderColor: '#f59e0b', borderWidth: 2, arrowHeads: { end: { display: true, fill: true } } },
                            arrow2: { type: 'line', borderColor: '#10b981', borderWidth: 2, arrowHeads: { end: { display: true, fill: true } } }
                        }
                    }
                },
                scales: {
                    x: { type: 'linear', min: -10, max: 55, title: { display: true, text: 'Temperatur (°C)' } },
                    y: { min: 0, max: 60, title: { display: true, text: 'Abs. Feuchte (g/kg)' } }
                }
            }
        });

        // --- MAIN LOGIC ---
        let isCalculating = false;
        let outputManuallyChanged = false;

        function calculateResults() {
            if(isCalculating) return;
            isCalculating = true;

            const tIn = parseFloat(inputs.tIn.text.value);
            const hIn = parseFloat(inputs.hIn.text.value);
            const simHeat = parseFloat(inputs.simHeat.text.value);
            const simDry = parseFloat(inputs.simDry.text.value);
            const alt = parseFloat(inputs.altitude.text.value);
            const flow = parseFloat(inputs.flowRate.text.value);
            const isAdiabat = inputs.checkAdiabat.checked;

            const press = getAirPressure(alt);
            const dens = getAirDensity(tIn, press); 

            // 1. Aussen
            const x1 = getAbsHumidity(tIn, hIn, press);

            // 2. Eintritt (Aufbereitet)
            const t2 = tIn + simHeat;
            const x2 = Math.max(0, x1 - simDry);
            const h2 = getRelHumidity(t2, x2, press);
            const enth2 = getEnthalpy(t2, x2);

            // AUTO-FOLLOW LOGIC 
            if (!outputManuallyChanged && !isAdiabat) {
                inputs.tOut.slider.value = t2;
                inputs.tOut.text.value = t2.toFixed(1);
                inputs.hOut.slider.value = h2;
                inputs.hOut.text.value = h2.toFixed(0);
                outputs.syncIndicator.classList.remove('hidden');
            } else if (isAdiabat) {
                outputs.syncIndicator.classList.add('hidden');
            } else {
                outputs.syncIndicator.classList.add('hidden');
            }

            // 3. Austritt
            let tOut = parseFloat(inputs.tOut.text.value);
            let hOut = parseFloat(inputs.hOut.text.value);

            if (isAdiabat) {
                inputs.tOut.text.disabled = true;
                inputs.tOut.slider.disabled = true;
                outputs.tOutContainer.classList.add('disabled-group');
                tOut = solveTempForEnthalpy(enth2, hOut, press);
                inputs.tOut.text.value = tOut.toFixed(1);
                inputs.tOut.slider.value = tOut.toFixed(1);
            } else {
                inputs.tOut.text.disabled = false;
                inputs.tOut.slider.disabled = false;
                outputs.tOutContainer.classList.remove('disabled-group');
            }

            const x3 = getAbsHumidity(tOut, hOut, press);

            // Ergebnisse
            const deltaX = x3 - x2; // g/kg
            const waterPerM3 = deltaX * dens; 
            const waterTotal = (waterPerM3 / 1000) * flow * 3600;
            const ts = estimateTM(hOut);

            // AMPEL LOGIK (INTELLIGENT)
            let statusType = ''; 

            if (deltaX < -0.1) {
                // RÜCKBEFEUCHTUNG: Absolut kritisch, egal wie das Heu ist.
                statusType = 'rewet';
            } else if (deltaX >= -0.1 && hOut > 85) {
                // SÄTTIGUNG BEI ENTZUG: Das ist die klassische Startphase oder sehr nasses Heu.
                // Da DeltaX nicht negativ ist, nehmen wir Wasser auf -> GUT für Start, Schlecht für Lager.
                // Wir nennen es "Startphase / Nass"
                statusType = 'wet_start';
            } else if (hOut <= 65 && deltaX > 0.1) {
                statusType = 'good';
            } else {
                statusType = 'mid'; // Intervallbereich
            }

            isCalculating = false;
            return { p1: { x: tIn, y: x1, rh: hIn }, p2: { x: t2, y: x2, rh: h2, enth: enth2 }, p3: { x: tOut, y: x3, rh: hOut }, res: { waterPerM3, waterTotal, ts, dens, press }, statusType };
        }

        function updateUI() {
            const data = calculateResults();
            if(!data) return; 

            outputs.headerInfo.alt.textContent = inputs.altitude.text.value + " m";
            outputs.headerInfo.press.textContent = Math.round(data.res.press) + " hPa";
            outputs.headerInfo.dens.textContent = data.res.dens.toFixed(2) + " kg/m³";

            outputs.resCondTemp.textContent = data.p2.x.toFixed(1);
            outputs.resCondRh.textContent = data.p2.rh.toFixed(0);

            outputs.waterH.textContent = data.res.waterTotal.toFixed(1);
            
            outputs.waterM3Big.textContent = data.res.waterPerM3.toFixed(2);
            outputs.waterM3Big.className = `text-5xl font-extrabold ${data.res.waterPerM3 > 0.1 ? 'text-blue-600' : (data.res.waterPerM3 < -0.1 ? 'text-red-500' : 'text-slate-400')}`;

            outputs.tmValue.textContent = data.res.ts;
            outputs.tmBar.style.width = Math.min(100, Math.max(0, (parseFloat(data.res.ts)-50)*2)) + "%";

            // AMPEL UI UPDATE
            [outputs.ampelStart, outputs.ampelMid, outputs.ampelGood].forEach(el => el.classList.remove('active'));

            // Reset Classes for Start Box
            outputs.ampelStart.className = "ampel-box rounded-xl p-4 flex flex-col items-center text-center";
            outputs.ampelStartIconBg.className = "p-2 mb-2 rounded-full";
            
            // LOGIC
            if (data.statusType === 'rewet') {
                // ROT: Rückbefeuchtung
                outputs.ampelStart.classList.add('active', 'bg-red-50', 'border-red-200');
                outputs.ampelStartIconBg.classList.add('bg-red-100', 'text-red-600');
                outputs.ampelStartIcon.setAttribute('class', 'lucide lucide-alert-triangle w-6 h-6');
                outputs.ampelStartIcon.innerHTML = '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path>';
                outputs.ampelStartTitle.textContent = "Gefahr: Rückbefeuchtung";
                outputs.ampelStartTitle.className = "font-bold text-red-800";
                outputs.ampelStartText.textContent = "Stoppen oder Heizen! Heu nimmt Feuchtigkeit auf.";
                outputs.ampelStartText.className = "text-xs text-red-700 mt-1 leading-tight";

            } else if (data.statusType === 'wet_start') {
                // LILA/BLAU: Startphase / Viel Wasser
                outputs.ampelStart.classList.add('active', 'bg-indigo-50', 'border-indigo-200');
                outputs.ampelStartIconBg.classList.add('bg-indigo-100', 'text-indigo-600');
                outputs.ampelStartIcon.setAttribute('class', 'lucide lucide-waves w-6 h-6');
                outputs.ampelStartIcon.innerHTML = '<path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>';
                outputs.ampelStartTitle.textContent = "Startphase / Nass";
                outputs.ampelStartTitle.className = "font-bold text-indigo-800";
                outputs.ampelStartText.textContent = "Abluft gesättigt (>85%), aber Entzug positiv. Dauerbetrieb ok.";
                outputs.ampelStartText.className = "text-xs text-indigo-700 mt-1 leading-tight";

            } else if (data.statusType === 'mid') {
                outputs.ampelMid.classList.add('active');
                // Deactivate visual style of start box if not active
                outputs.ampelStart.classList.add('opacity-40');
                outputs.ampelStartIconBg.classList.add('bg-slate-100', 'text-slate-400');
                outputs.ampelStartIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'; // Info Icon neutral
                outputs.ampelStartTitle.textContent = "Start / Gefahr";
                outputs.ampelStartTitle.className = "font-bold text-slate-400";
                outputs.ampelStartText.textContent = "-";

            } else if (data.statusType === 'good') {
                outputs.ampelGood.classList.add('active');
                 // Deactivate visual style of start box
                outputs.ampelStart.classList.add('opacity-40');
                outputs.ampelStartIconBg.classList.add('bg-slate-100', 'text-slate-400');
                outputs.ampelStartIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
                outputs.ampelStartTitle.textContent = "Start / Gefahr";
                outputs.ampelStartTitle.className = "font-bold text-slate-400";
                outputs.ampelStartText.textContent = "-";
            }

            // Chart Update
            const maxTemp = Math.max(50, data.p2.x + 5);
            absFeuchteChart.options.scales.x.max = maxTemp;
            for(let i=0; i<10; i++) {
                absFeuchteChart.data.datasets[i].data = generateRelHumidityCurve(100 - i*10, -10, maxTemp, data.res.press);
            }
            absFeuchteChart.data.datasets[10].data = [data.p1, data.p2, data.p3];
            
            const ann = absFeuchteChart.options.plugins.annotation.annotations;
            ann.arrow1.xMin = data.p1.x; ann.arrow1.yMin = data.p1.y; ann.arrow1.xMax = data.p2.x; ann.arrow1.yMax = data.p2.y;
            ann.arrow2.xMin = data.p2.x; ann.arrow2.yMin = data.p2.y; ann.arrow2.xMax = data.p3.x; ann.arrow2.yMax = data.p3.y;

            absFeuchteChart.update();
        }

        // --- HISTORY CHART ---
        const hCtx = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(hCtx, {
            type: 'line', data: { labels: [], datasets: [{ label: 'Entzug (kg/h)', data: [], borderColor: '#10b981', tension: 0.1, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        document.getElementById('save-measurement-btn').addEventListener('click', () => {
            const res = calculateResults().res;
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            historyChart.data.labels.push(time);
            historyChart.data.datasets[0].data.push(res.waterTotal);
            if(historyChart.data.labels.length > 20) { historyChart.data.labels.shift(); historyChart.data.datasets[0].data.shift(); }
            historyChart.update();
        });
        document.getElementById('clear-history-btn').addEventListener('click', () => {
            historyChart.data.labels = []; historyChart.data.datasets[0].data = []; historyChart.update();
        });

        // --- EVENT BINDING ---
        // Input Groups (Auto-Follow möglich wenn nicht outputManuallyChanged)
        [inputs.tIn, inputs.hIn, inputs.simHeat, inputs.simDry].forEach(grp => {
             if(grp.slider) {
                const update = () => {
                    grp.text.value = parseFloat(grp.slider.value).toFixed(grp.slider.step.includes('.') ? 1 : 0);
                    updateUI();
                };
                grp.slider.addEventListener('input', update);
                grp.text.addEventListener('change', () => { grp.slider.value = grp.text.value; updateUI(); });
             }
        });

        // Altitude & Flow (Kein Einfluss auf Auto-Follow Status)
        [inputs.altitude, inputs.flowRate].forEach(grp => {
             const update = () => {
                grp.text.value = parseFloat(grp.slider.value).toFixed(grp.slider.step.includes('.') ? 1 : 0);
                updateUI();
            };
            grp.slider.addEventListener('input', update);
            grp.text.addEventListener('change', () => { grp.slider.value = grp.text.value; updateUI(); });
        });

        // Output Groups (Setzt outputManuallyChanged = true)
        [inputs.tOut, inputs.hOut].forEach(grp => {
            if(grp.slider) {
                const update = () => {
                    outputManuallyChanged = true; // USER INTERACTION DETECTED
                    grp.text.value = parseFloat(grp.slider.value).toFixed(grp.slider.step.includes('.') ? 1 : 0);
                    updateUI();
                };
                grp.slider.addEventListener('input', update);
                grp.text.addEventListener('change', () => { 
                    outputManuallyChanged = true;
                    grp.slider.value = grp.text.value; 
                    updateUI(); 
                });
            }
        });

        inputs.checkAdiabat.addEventListener('change', updateUI);

        // Weather Fetch
        document.getElementById('fetch-weather-btn').addEventListener('click', () => {
             const status = document.getElementById('weather-status-message');
             status.textContent = "Ortung...";
             if(!navigator.geolocation) { status.textContent = "Kein GPS"; return; }
             navigator.geolocation.getCurrentPosition(async (pos) => {
                 status.textContent = "Lade...";
                 try {
                     const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m,relative_humidity_2m`);
                     const d = await r.json();
                     
                     inputs.tIn.slider.value = d.current.temperature_2m;
                     inputs.tIn.text.value = d.current.temperature_2m;
                     inputs.hIn.slider.value = d.current.relative_humidity_2m;
                     inputs.hIn.text.value = d.current.relative_humidity_2m;
                     outputManuallyChanged = false; // Reset Manual Override
                     updateUI();
                     status.textContent = "Aktualisiert";
                 } catch(e) { status.textContent = "Fehler"; }
             });
        });

        updateUI();
        lucide.createIcons();
    });
    </script>

</body></html>
