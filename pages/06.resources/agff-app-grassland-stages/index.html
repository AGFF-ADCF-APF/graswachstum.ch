<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGFF Zeitverlauf N√§hrwerte</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Lade-Spinner -->
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="mt-4 text-gray-600">Lade Futterwert-Daten (futterwerte.csv)...</p>
        </div>
    </div>

    <!-- Hauptinhalt (versteckt bis CSV geladen ist) -->
    <div id="main-content" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-3xl flex-shrink-0">üìà</span>
                        <div class="ml-3">
                            <h1 class="text-2xl font-semibold text-gray-800">Zeitverlauf Futterqualit√§t (1. Aufwuchs)</h1>
                            <p class="text-sm text-gray-500">Basierend auf AGFF-Daten (CSV & PDF 2024)</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <!-- Linke Spalte: Filter -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="p-5 bg-white rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700 border-b pb-3">Filter & Parameter</h2>
                        
                        <!-- NEU: Filter Konservierung -->
                        <div>
                            <label for="filter-konservierung" class="block text-sm font-medium text-gray-600 mb-1">Konservierungsart (1. Aufwuchs)</label>
                            <select id="filter-konservierung" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="greenfeed">Gr√ºnfutter</option>
                                <option value="silage">Silage</option>
                                <option value="hay">D√ºrrfutter</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="filter-bestand" class="block text-sm font-medium text-gray-600 mb-1">Bestandestyp</label>
                            <select id="filter-bestand" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="A">A: Ausgewogen (andere Gr√§ser)</option>
                                <option value="G">G: Gr√§serreich (andere Gr√§ser)</option>
                                <option value="L">L: Leguminosenreich</option>
                                <option value="GR">GR: Gr√§serreich (Raigr√§ser)</option>
                                <option value="AR">AR: Ausgewogen (Raigr√§ser)</option>
                                <option value="KF">KF: Kr√§uterreich (feinbl√§ttrig)</option>
                                <option value="KG">KG: Kr√§uterreich (grobst√§ngelig)</option>
                            </select>
                        </div>

                        <div>
                            <label for="filter-zone" class="block text-sm font-medium text-gray-600 mb-1">H√∂henlage / Zone (aus PDF 2024)</label>
                            <select id="filter-zone" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="mild">Mild (400-600m)</option>
                                <option value="normal">Normal (600-800m)</option>
                                <option value="kuehl">K√ºhl (800-1000m)</option>
                                <option value="rau">Rau (1000-1200m)</option>
                            </select>
                        </div>
                        
                        <!-- NEU: Parameter Kuhgewicht -->
                        <div>
                            <label for="param-kuhgewicht" class="block text-sm font-medium text-gray-600 mb-1">Kuhgewicht (f√ºr MPP-Berechnung)</label>
                            <input type="number" id="param-kuhgewicht" value="630" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                    </div>
                </div>

                <!-- Rechte Spalte: Diagramme -->
                <div class="lg:col-span-8 space-y-8">
                    <div class="p-5 bg-white rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">NEL (Energie) & Stadium</h3>
                        <div id="chart-nel" class="w-full h-[400px]"></div>
                    </div>
                    <div class="p-5 bg-white rounded-2xl shadow-lg">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">APDE & APDN (Protein) & Stadium</h3>
                        <div id="chart-protein" class="w-full h-[400px]"></div>
                    </div>
                    <!-- NEU: MPP Diagramm -->
                    <div class="p-5 bg-white rounded-2xl shadow-lg">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">Milchproduktionspotenzial (MPP) & Stadium</h3>
                        <div id="chart-mpp" class="w-full h-[400px]"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        
        // --- GLOBALE VARIABLEN ---
        let futterWerte = {}; // Wird jetzt wieder aus CSV geladen
        
        // Konstanten f√ºr MPP-Berechnung (aus index.html)
        const PB_NEL = 3.14;
        const PB_PROTEIN = 50;
        
        // --- DATENBANK (AUS PDF 2024, S. 2) ---
        function addDays(dateStr, days) {
            // Pr√ºft, ob der dateStr g√ºltig ist, bevor eine Operation ausgef√ºhrt wird
            if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('-')) {
                return null; // Gibt null zur√ºck, wenn das Basisdatum ung√ºltig ist
            }
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return null; // Ung√ºltiges Datumsobjekt
            }
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        const timelineDataBase = {
            "mild": { "3": "2024-05-14", "4": "2024-05-28", "5": "2024-06-04", "6": "2024-06-11" },
            "normal": { "3": "2024-05-21", "4": "2024-05-28", "5": "2024-06-04", "6": "2024-06-11" },
            "kuehl": { "3": "2024-05-28", "4": "2024-06-04", "5": "2024-06-11", "6": "2024-06-18" },
            "rau": { "3": "2024-06-04", "4": "2024-06-11", "5": "2024-06-18", "6": "2024-06-25" }
        };
        
        const timelineData = {};
        for (const zone in timelineDataBase) {
            const base = timelineDataBase[zone];
            timelineData[zone] = {
                "1": addDays(base["3"], -14),
                "2": addDays(base["3"], -7),
                "3": base["3"],
                "4": base["4"],
                "5": base["5"],
                "6": base["6"],
                "7": addDays(base["6"], 7)
            };
        }

        // --- APP-LOGIK ---

        // Filter-Elemente beim Start abrufen
        const bestandFilter = document.getElementById('filter-bestand');
        const zoneFilter = document.getElementById('filter-zone');
        const konservFilter = document.getElementById('filter-konservierung');
        const kuhgewichtInput = document.getElementById('param-kuhgewicht');

        
        /**
         * Parst den CSV-Text (exakte Kopie von index.html)
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("CSV-Datei ist leer.");

            const headers = lines[0].split(';').map(h => h.trim());
            
            const colIdx = {
                futterart: headers.findIndex(h => h.toLowerCase() === 'futterart'),
                bestand: headers.findIndex(h => h.toLowerCase() === 'bestand'),
                aufwuchs: headers.findIndex(h => h.toLowerCase() === 'aufwuchs'),
                stadium: headers.findIndex(h => h.toLowerCase() === 'stadium'),
                nel: headers.findIndex(h => h.toLowerCase().startsWith('nel')),
                nev: headers.findIndex(h => h.toLowerCase().startsWith('nev')),
                apde: headers.findIndex(h => h.toLowerCase().startsWith('apde')),
                apdn: headers.findIndex(h => h.toLowerCase().startsWith('apdn')),
                rp: headers.findIndex(h => h.toLowerCase().startsWith('rp')),
                rf: headers.findIndex(h => h.toLowerCase().startsWith('rf')),
                ndf: headers.findIndex(h => h.toLowerCase().startsWith('ndf')),
                adf: headers.findIndex(h => h.toLowerCase().startsWith('adf')),
                zucker: headers.findIndex(h => h.toLowerCase().startsWith('zucker')),
                vos: headers.findIndex(h => h.toLowerCase().startsWith('vos')),
                ra: headers.findIndex(h => h.toLowerCase().startsWith('ra'))
            };

            const requiredCols = ['futterart', 'bestand', 'aufwuchs', 'stadium', 'nel', 'nev', 'apde', 'apdn'];
            for (const col of requiredCols) {
                if (colIdx[col] === -1) throw new Error(`Erforderliche Spalte "${col}" nicht in CSV gefunden.`);
            }

            futterWerte = { erster: {}, folge: {} }; // Initialisieren

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                if (values.length < headers.length) continue; 

                const futterartDE = values[colIdx.futterart]?.trim().toLowerCase();
                const aufwuchsDE = values[colIdx.aufwuchs]?.trim().toLowerCase();
                const bestand = values[colIdx.bestand]?.trim().toUpperCase();
                const stadium = values[colIdx.stadium]?.trim();

                let konservierung, aufwuchs;

                if (aufwuchsDE.includes('erster') || aufwuchsDE.startsWith('1')) aufwuchs = 'erster';
                else if (aufwuchsDE.includes('folge')) aufwuchs = 'folge';
                else continue; 

                if (futterartDE.startsWith('gr√ºnfutter')) konservierung = 'greenfeed';
                else if (futterartDE.startsWith('silage')) konservierung = 'silage';
                else if (futterartDE.startsWith('d√ºrrfutter')) konservierung = 'hay';
                else continue; 

                if (!bestand || !stadium) continue;

                if (!futterWerte[aufwuchs]) futterWerte[aufwuchs] = {};
                if (!futterWerte[aufwuchs][konservierung]) futterWerte[aufwuchs][konservierung] = {};
                if (!futterWerte[aufwuchs][konservierung][bestand]) futterWerte[aufwuchs][konservierung][bestand] = {};

                const getVal = (idx) => {
                    if (idx === -1 || !values[idx]) return 0; // 0 ist hier OK, wird sp√§ter zu null
                    return parseFloat(values[idx].replace(',', '.')) || 0;
                };

                futterWerte[aufwuchs][konservierung][bestand][stadium] = {
                    nel: getVal(colIdx.nel),
                    nev: getVal(colIdx.nev),
                    apde: getVal(colIdx.apde),
                    apdn: getVal(colIdx.apdn),
                    rp: getVal(colIdx.rp),
                    rf: getVal(colIdx.rf),
                    ndf: getVal(colIdx.ndf),
                    adf: getVal(colIdx.adf),
                    zucker: getVal(colIdx.zucker),
                    vos: getVal(colIdx.vos),
                    ra: getVal(colIdx.ra)
                };
            }
            console.log("CSV-Daten erfolgreich verarbeitet.");
        }
        
        /**
         * L√§dt die futterwerte.csv (wie in index.html)
         */
        async function loadAndParseCSV() {
            try {
                // KORREKTUR: Verwendet './futterwerte.csv', um sicherzustellen, 
                // dass es im aktuellen Verzeichnis gesucht wird (f√ºr lokale Ausf√ºhrung).
                const response = await fetch('./futterwerte.csv'); 
                if (!response.ok) {
                    throw new Error(`HTTP-Fehler! Status: ${response.status}`);
                }
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                console.error("Fehler beim Laden der CSV-Datei:", error);
                showLoading(true, "Fehler: futterwerte.csv konnte nicht geladen werden.", true);
                throw error; // Stoppt die weitere Ausf√ºhrung
            }
        }

        /**
         * Berechnet alle 3 MPP-Werte f√ºr ein gegebenes Stadium
         */
        function calculateAllMpps(qualities, kuhGewicht) {
            // KORREKTUR: Gibt null zur√ºck, wenn keine Daten vorhanden sind
            if (!qualities || !qualities.nel) {
                return { mppNEL: null, mppAPDE: null, mppAPDN: null };
            }

            const nel = qualities.nel || 0;
            const apde = qualities.apde || 0;
            const apdn = qualities.apdn || 0;

            const nelAbweichung = (nel - 5.6) / 0.1;
            const automatischTSV = 16.0 + (nelAbweichung * 0.3);

            const EB_NEL = (0.293 * Math.pow(kuhGewicht, 0.75)) * 1.1; 
            const EB_PROTEIN = (3.25 * Math.pow(kuhGewicht, 0.75)) * 1.1; 

            const aufnahmeNEL = nel * automatischTSV;
            const aufnahmeAPDE = apde * automatischTSV;
            const aufnahmeAPDN = apdn * automatischTSV;

            const mppNEL = Math.max(0, (aufnahmeNEL - EB_NEL) / PB_NEL); 
            const mppAPDE = Math.max(0, (aufnahmeAPDE - EB_PROTEIN) / PB_PROTEIN); 
            const mppAPDN = Math.max(0, (aufnahmeAPDN - EB_PROTEIN) / PB_PROTEIN); 

            return { mppNEL, mppAPDE, mppAPDN };
        }


        /**
         * Hauptfunktion zum Zeichnen aller Diagramme
         */
        function drawCharts() {
            const bestand = bestandFilter.value;
            const zone = zoneFilter.value;
            const konservierung = konservFilter.value;
            const kuhGewicht = parseFloat(kuhgewichtInput.value) || 630;

            // Datenbasis f√ºr die Auswahl holen
            const qualitiesByStadium = futterWerte['erster']?.[konservierung]?.[bestand];
            const timeline = timelineData[zone];

            // Container f√ºr Fehler-Handling
            const chartNelContainer = document.getElementById('chart-nel');
            const chartProteinContainer = document.getElementById('chart-protein');
            const chartMppContainer = document.getElementById('chart-mpp');

            if (!qualitiesByStadium || !timeline) {
                const errorMsg = `Daten nicht gefunden f√ºr: ${konservierung}, ${bestand}, ${zone}`;
                console.error(errorMsg);
                chartNelContainer.innerHTML = `<p class="text-red-500 p-4">${errorMsg}</p>`;
                chartProteinContainer.innerHTML = "";
                chartMppContainer.innerHTML = "";
                return;
            } else {
                chartNelContainer.innerHTML = ""; // Fehler l√∂schen, falls vorhanden
            }

            const labels = [
                'Stadium 1<br>(Bestockung)',
                'Stadium 2<br>(Schossen)',
                'Stadium 3<br>(Beginn Rispenschieben)',
                'Stadium 4<br>(Volles Rispenschieben)',
                'Stadium 5<br>(Ende Rispenschieben)',
                'Stadium 6<br>(Bl√ºte)',
                'Stadium 7<br>(Samenreife)'
            ];
            
            const stadiumKeys = ['1', '2', '3', '4', '5', '6', '7'];
            
            const dates = stadiumKeys.map(stadium => timeline[stadium]);
            const stadium_indices = stadiumKeys.map(stadium => parseInt(stadium));
            
            // KORREKTUR: Verwendet '|| null' statt '|| 0', um L√ºcken zu erzeugen
            const nel_values = stadiumKeys.map(stadium => qualitiesByStadium[stadium]?.nel || null);
            const apde_values = stadiumKeys.map(stadium => qualitiesByStadium[stadium]?.apde || null);
            const apdn_values = stadiumKeys.map(stadium => qualitiesByStadium[stadium]?.apdn || null);

            const mpp_nel_values = [];
            const mpp_apde_values = [];
            const mpp_apdn_values = [];

            stadiumKeys.forEach(stadium => {
                const qualities = qualitiesByStadium[stadium];
                // calculateAllMpps gibt jetzt {mppNEL: null, ...} zur√ºck, wenn Daten fehlen
                const { mppNEL, mppAPDE, mppAPDN } = calculateAllMpps(qualities, kuhGewicht);
                mpp_nel_values.push(mppNEL);
                mpp_apde_values.push(mppAPDE);
                mpp_apdn_values.push(mppAPDN);
            });

            // Dynamische Titel basierend auf Auswahl
            const konservLabel = konservFilter.options[konservFilter.selectedIndex].text;
            const bestandLabel = bestandFilter.options[bestandFilter.selectedIndex].text.split(':')[0];
            const zoneLabel = zoneFilter.options[zoneFilter.selectedIndex].text;
            const chartTitle = `Verlauf: ${konservLabel} / ${bestandLabel} / ${zoneLabel}`;


            // --- Diagramm 1: NEL ---
            const traceNEL = {
                x: dates, y: nel_values, mode: 'lines+markers', name: 'NEL (MJ/kg TS)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(22, 163, 74)', width: 3 }
            };
            const traceStadium1 = {
                x: dates, y: stadium_indices, mode: 'lines+markers', name: 'Stadium (Index)',
                text: labels, hoverinfo: 'x+y+text', yaxis: 'y2', line: { color: 'rgb(202, 138, 4)', dash: 'dot' }
            };
            const layoutNEL = {
                title: chartTitle, xaxis: { title: 'Datum (2024)' },
                // KORREKTUR: Y-Achse beginnt bei 0
                yaxis: { title: 'NEL (MJ/kg TS)', color: 'rgb(22, 163, 74)', range: [0, 8] },
                yaxis2: { title: 'Stadium', color: 'rgb(202, 138, 4)', overlaying: 'y', side: 'right', range: [0.5, 7.5] },
                legend: { x: 0.01, y: 0.99 }, hovermode: 'x unified'
            };
            Plotly.newPlot(chartNelContainer, [traceNEL, traceStadium1], layoutNEL, {responsive: true});

            // --- Diagramm 2: Protein ---
             const traceAPDE = {
                x: dates, y: apde_values, mode: 'lines+markers', name: 'APDE (g/kg TS)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(37, 99, 235)', width: 3 }
            };
             const traceAPDN = {
                x: dates, y: apdn_values, mode: 'lines+markers', name: 'APDN (g/kg TS)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(219, 39, 119)', width: 2, dash: 'dash' }
            };
            const traceStadium2 = { ...traceStadium1 };
            const layoutProtein = {
                title: chartTitle, xaxis: { title: 'Datum (2024)' },
                // KORREKTUR: Y-Achse beginnt bei 0
                yaxis: { title: 'APDE / APDN (g/kg TS)', color: 'rgb(37, 99, 235)', range: [0, 180] }, 
                yaxis2: { title: 'Stadium', color: 'rgb(202, 138, 4)', overlaying: 'y', side: 'right', range: [0.5, 7.5] },
                legend: { x: 0.01, y: 0.99 }, hovermode: 'x unified'
            };
            Plotly.newPlot(chartProteinContainer, [traceAPDE, traceAPDN, traceStadium2], layoutProtein, {responsive: true});
            
            // --- Diagramm 3: MPP ---
            const traceMppNEL = {
                x: dates, y: mpp_nel_values, mode: 'lines+markers', name: 'MPP (lim. NEL)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(22, 163, 74)', width: 3 }
            };
            const traceMppAPDE = {
                x: dates, y: mpp_apde_values, mode: 'lines+markers', name: 'MPP (lim. APDE)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(37, 99, 235)', width: 2, dash: 'dash' }
            };
            const traceMppAPDN = {
                x: dates, y: mpp_apdn_values, mode: 'lines+markers', name: 'MPP (lim. APDN)',
                text: labels, hoverinfo: 'x+y+text', line: { color: 'rgb(219, 39, 119)', width: 2, dash: 'dot' }
            };
            const traceStadium3 = { ...traceStadium1 };
            const layoutMPP = {
                title: chartTitle + ` (Kuh: ${kuhGewicht}kg)`, xaxis: { title: 'Datum (2024)' },
                // Diese Achse begann bereits bei 0
                yaxis: { title: 'MPP (kg ECM/Tag)', color: 'rgb(55, 65, 81)', range: [0, 30] },
                yaxis2: { title: 'Stadium', color: 'rgb(202, 138, 4)', overlaying: 'y', side: 'right', range: [0.5, 7.5] },
                legend: { x: 0.01, y: 0.99 }, hovermode: 'x unified'
            };
            Plotly.newPlot(chartMppContainer, [traceMppNEL, traceMppAPDE, traceMppAPDN, traceStadium3], layoutMPP, {responsive: true});
        }
        
        /**
         * Zeigt/versteckt den Lade-Spinner
         */
        function showLoading(isLoading, message = "Lade...", isError = false) {
            const spinnerWrapper = document.getElementById('loading-spinner');
            const spinnerMessage = document.getElementById('loading-message');
            const mainContent = document.getElementById('main-content');
            
            if (isLoading) {
                spinnerMessage.textContent = message;
                spinnerWrapper.classList.remove('hidden');
                mainContent.classList.add('hidden');
                if(isError) {
                     spinnerMessage.classList.add('text-red-500');
                     spinnerWrapper.querySelector('svg').classList.add('hidden');
                } else {
                     spinnerMessage.classList.remove('text-red-500');
                     spinnerWrapper.querySelector('svg').classList.remove('hidden');
                }
            } else {
                spinnerWrapper.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        /**
         * Richtet die Event-Listener f√ºr die Filter ein
         */
        function setupEventListeners() {
             // Alle Filter-Elemente
            bestandFilter.addEventListener('change', drawCharts);
            zoneFilter.addEventListener('change', drawCharts);
            konservFilter.addEventListener('change', drawCharts);
            kuhgewichtInput.addEventListener('input', drawCharts); // 'input' f√ºr Live-√Ñnderung
        }

        // --- Initiales Laden (NEU) ---
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true, "Lade Futterwert-Daten (futterwerte.csv)...");
            try {
                // L√§dt die CSV-Datei, bevor die App gestartet wird
                await loadAndParseCSV(); 
                
                // Versteckt Lade-Spinner und zeigt Inhalt
                showLoading(false);
                
                // Richtet Filter-Listener ein
                setupEventListeners();
                
                // Zeichnet die Diagramme zum ersten Mal
                drawCharts();
                
            } catch (e) {
                // Fehler wird bereits im Lade-Spinner angezeigt
                console.error("Konnte App nicht initialisieren.", e);
            }
        });

    </script>
</body>
</html>