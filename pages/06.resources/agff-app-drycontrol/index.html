<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heutrocknung Rechner</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 3. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 4. Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- 5. NEU: Chart.js Annotation Plugin (für Pfeile) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* Versteckt die Pfeile in Nummern-Eingabefeldern */
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 p-4 md:p-6 lg:p-8">

    <div class="max-w-5xl mx-auto">
        
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 flex items-center gap-2">
                    <i data-lucide="wind" class="text-blue-600"></i>
                    Heutrocknung
                </h1>
                <p class="text-slate-500 mt-1">Rechner für Wasserentzug & Trocknungsstrategie</p>
            </div>
            <div class="flex gap-4 text-sm text-slate-500 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200">
                 <div class="flex items-center gap-1">
                    <i data-lucide="gauge" class="h-4 w-4"></i>
                    <span id="altitude-display">600 m ü.M.</span>
                 </div>
                 <div class="w-px h-4 bg-slate-200"></div>
                 <div id="pressure-display">947 hPa</div>
                 <div class="w-px h-4 bg-slate-200"></div>
                 <div id="density-display">1.11 kg/m³</div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
            <!-- Linke Spalte: Eingaben -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Card: Zuluft -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700">Zuluft (Ein)</div>
                    <div class="p-4">
                        <!-- InputGroup: tIn -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="thermometer" class="h-4 w-4 text-slate-400"></i> Temperatur (Tein)
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <!-- NEUER Standardwert: 20 -->
                                    <input type="number" id="tIn-text" min="0" max="45" step="0.5" value="20" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">°C</span>
                                </div>
                            </div>
                            <!-- NEUER Standardwert: 20 -->
                            <input type="range" id="tIn-slider" min="0" max="45" step="0.5" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <!-- InputGroup: hIn -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="droplets" class="h-4 w-4 text-slate-400"></i> Rel. Feuchte (Hein)
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <!-- NEUER Standardwert: 65 -->
                                    <input type="number" id="hIn-text" min="10" max="100" step="1" value="65" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">%</span>
                                 </div>
                            </div>
                            <!-- NEUER Standardwert: 65 -->
                            <input type="range" id="hIn-slider" min="10" max="100" step="1" value="65" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        
                        <!-- Button für Wetter-Abruf -->
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <button id="fetch-weather-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-150">
                                <i data-lucide="map-pin" class="h-4 w-4"></i>
                                Aktuelle Aussenluft abrufen
                            </button>
                            <p id="weather-status-message" class="text-xs text-slate-500 text-center mt-2 h-4"></p>
                        </div>
                    </div>
                </div>

                <!-- Card: Abluft -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700">Abluft (Aus)</div>
                    <div class="p-4">
                        <!-- InputGroup: tOut -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="thermometer" class="h-4 w-4 text-slate-400"></i> Temperatur (Taus)
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <!-- NEUER Standardwert: 20 -->
                                    <input type="number" id="tOut-text" min="0" max="50" step="0.5" value="20" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">°C</span>
                                </div>
                            </div>
                            <!-- NEUER Standardwert: 20 -->
                            <input type="range" id="tOut-slider" min="0" max="50" step="0.5" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <!-- InputGroup: hOut -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="droplets" class="h-4 w-4 text-slate-400"></i> Rel. Feuchte (Haus)
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <!-- NEUER Standardwert: 65 -->
                                    <input type="number" id="hOut-text" min="10" max="100" step="1" value="65" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">%</span>
                                </div>
                            </div>
                            <!-- NEUER Standardwert: 65 -->
                            <input type="range" id="hOut-slider" min="10" max="100" step="1" value="65" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        
                        <!-- "Auswertung starten" Button ENTFERNT -->
                    </div>
                </div>

                <!-- Card: Anlagenparameter -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700">Anlagenparameter (Optional)</div>
                    <div class="p-4">
                        <!-- InputGroup: altitude -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="activity" class="h-4 w-4 text-slate-400"></i> Höhe über Meer
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <input type="number" id="altitude-text" min="0" max="2500" step="50" value="600" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">m</span>
                                </div>
                            </div>
                            <input type="range" id="altitude-slider" min="0" max="2500" step="50" value="600" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <!-- InputGroup: flowRate -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <i data-lucide="wind" class="h-4 w-4 text-slate-400"></i> Luftmenge (Volumenstrom)
                                </label>
                                <div class="flex items-center gap-2 bg-slate-100 border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                    <input type="number" id="flowRate-text" min="0" max="100" step="0.5" value="0" class="w-20 text-right font-bold text-slate-900 bg-transparent py-2 px-2.5 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                    <span class="text-slate-500 font-normal pr-3">m³/s</span>
                                </div>
                            </div>
                            <input type="range" id="flowRate-slider" min="0" max="100" step="0.5" value="0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>
                </div>

            </div> <!-- ENDE von lg:col-span-1 -->

            <!-- Rechte Spalte: Ergebnisse & Dashboard -->
            <!-- style="display: none;" ENTFERNT -->
            <div id="results-column" class="lg:col-span-2 space-y-6">

                <!-- Hauptentscheidungskarte -->
                <!-- GEÄNDERT: Zurück zu Platzhaltern -->
                <div id="decision-container" class="bg-slate-50 border-slate-200 rounded-2xl p-6 border shadow-sm flex flex-col md:flex-row items-center justify-between gap-6 transition-colors duration-300">
                    <div class="flex items-center gap-4">
                        <div id="decision-icon-container" class="p-3 rounded-full bg-white bg-opacity-50 border border-black/5">
                           <i data-lucide="info" class="h-8 w-8 text-slate-400"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold uppercase tracking-wide opacity-80 text-slate-500">Empfehlung</h2>
                            <p id="decision-status" class="text-2xl font-bold text-slate-600">Warte auf Eingabe</p>
                            <p id="decision-message" class="font-medium opacity-90 mt-1 text-slate-500">Bitte Werte in der linken Spalte anpassen.</p>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Wasserentzug Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="droplets" class="h-24 w-24"></i>
                        </div>
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700 flex items-center gap-2">
                            <i data-lucide="droplets" class="h-4 w-4"></i> Wasserentzug
                        </div>
                        <div class="p-4 space-y-6 relative z-10">
                            <!-- Metric: g/m³ -->
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Pro Kubikmeter Luft</span>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <!-- GEÄNDERT: Zurück zu Platzhalter -->
                                    <span id="water-m3" class="text-2xl font-bold text-slate-900">--.--</span>
                                    <span class="text-sm text-slate-400 font-medium">g / m³</span>
                                </div>
                            </div>
                            
                            <!-- Metric: kg/h (optional) -->
                            <div id="water-h-container" style="display: none;">
                                <div class="h-px bg-slate-100 w-full"></div>
                                <div class="flex flex-col mt-6">
                                    <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Gesamtleistung</span>
                                    <div class="flex items-baseline gap-1 mt-1">
                                        <span id="water-h" class="text-2xl font-bold text-slate-900">0.0</span>
                                        <span class="text-sm text-slate-400 font-medium">kg / h</span>
                                    </div>
                                    <span id="water-h-subtext" class="text-xs text-slate-400 mt-1">Bei 0 m³/s Luftstrom</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TM Gehalt Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="gauge" class="h-24 w-24"></i>
                        </div>
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700 flex items-center gap-2">
                             <i data-lucide="info" class="h-4 w-4"></i> Zustand Heustock
                        </div>
                        <div class="p-4 space-y-6 relative z-10">
                             <!-- Metric: TM % -->
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Geschätzter TM-Gehalt</span>
                                <div class="flex items-baseline gap-1 mt-1">
                                    <!-- GEÄNDERT: Zurück zu Platzhalter -->
                                    <span id="tm-value" class="text-2xl font-bold text-emerald-600">~ --.-</span>
                                    <span class="text-sm text-slate-400 font-medium">%</span>
                                </div>
                                <!-- Subtext-Container mit ID -->
                                <span id="tm-subtext" class="text-xs text-slate-400 mt-1">Basierend auf Gleichgewichtsfeuchte der Abluft</span>
                            </div>
                            
                            <div class="w-full bg-slate-100 rounded-full h-2.5 mt-2">
                                <!-- GEÄNDERT: Zurück zu Platzhalter -->
                                <div id="tm-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                               <span>Nass</span>
                               <span>Lagerfähig (&gt;86%)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualisierung: Aktuelles Diagramm (h-x DIAGRAMM) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700">Visualisierung: Trocknungspfad (h-x Diagramm)</div>
                    <div class="p-4">
                        <div class="h-80 w-full mt-4"> <!-- Höhe erhöht für bessere Lesbarkeit -->
                            <canvas id="absFeuchteChart"></canvas>
                        </div>
                    </div>
                </div>


                <!-- Verlaufschart & Protokoll-Knöpfe (KOMBINIERT) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-medium text-slate-700">Protokoll & Verlauf</div>
                    <div class="p-4">
                        <div class="h-80 w-full mt-4">
                            <canvas id="historyChart"></canvas>
                        </div>
                        <!-- Buttons hierher verschoben -->
                        <div class="mt-4 pt-4 border-t border-slate-100 space-y-3">
                            <button id="save-measurement-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-150">
                                <i data-lucide="save" class="h-4 w-4"></i>
                                Aktuelle Messung speichern
                            </button>
                            <button id="clear-history-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                                Protokoll löschen
                            </button>
                        </div>
                    </div>
                </div>

            </div> <!-- ENDE von lg:col-span-2 -->
        </div>
    </div>

    <!-- HIER BEGINNT DIE GESAMTE LOGIK DER APP -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // NEU: Chart.js Plugins registrieren
        Chart.register(ChartDataLabels, ChartjsPluginAnnotation); // Annotation Plugin hinzugefügt

        // --- HILFSFUNKTIONEN & PHYSIK ---

        const getSatVapPressure = (temp) => {
            return 6.112 * Math.exp((17.62 * temp) / (243.12 + temp));
        };

        const getAirPressure = (altitude) => {
            return 1013.25 * Math.pow(1 - 2.25577e-5 * altitude, 5.25588);
        };

        const getAbsHumidity = (temp, relHum, pressure) => {
            const satPress = getSatVapPressure(temp);
            const vapPress = satPress * (relHum / 100);
            return (622 * vapPress) / (pressure - vapPress);
        };

        const getAirDensity = (temp, pressure, absHum) => {
            const gasConstantDryAir = 287.05;
            const tempK = temp + 273.15;
            return (pressure * 100) / (gasConstantDryAir * tempK);
        };

        const estimateTM = (hOut) => {
            const points = [
                { rh: 90, tm: 68 },
                { rh: 80, tm: 74 },
                { rh: 70, tm: 78 },
                { rh: 60, tm: 82.5 },
                { rh: 50, tm: 85 }
            ];

            if (hOut >= points[0].rh) return points[0].tm.toFixed(1); 
            if (hOut <= points[points.length - 1].rh) return points[points.length - 1].tm.toFixed(1); 

            let p1, p2;
            for (let i = 0; i < points.length - 1; i++) {
                if (hOut >= points[i+1].rh && hOut < points[i].rh) {
                    p1 = points[i]; 
                    p2 = points[i+1];
                    break;
                }
            }

            const tm = p1.tm + (hOut - p1.rh) * (p2.tm - p1.tm) / (p2.rh - p1.rh);
            
            return tm.toFixed(1);
        };


        const generateRelHumidityCurve = (relHum, minTemp, maxTemp, pressure) => {
            const curve = [];
            for (let t = minTemp; t <= maxTemp; t += 0.5) { 
                const absHum_g_kg = getAbsHumidity(t, relHum, pressure);
                const density = getAirDensity(t, pressure, absHum_g_kg);
                const absHum_g_m3 = absHum_g_kg * density;
                curve.push({ x: t, y: absHum_g_m3 });
            }
            return curve;
        };

        // --- KONSTANTE ---
        const HISTORY_KEY = 'hayDryingHistory';
        const HISTORY_LIMIT = 50; 

        // --- DOM ELEMENTE ---
        
        const inputs = {
            tIn: { slider: document.getElementById('tIn-slider'), text: document.getElementById('tIn-text') },
            hIn: { slider: document.getElementById('hIn-slider'), text: document.getElementById('hIn-text') },
            tOut: { slider: document.getElementById('tOut-slider'), text: document.getElementById('tOut-text') },
            hOut: { slider: document.getElementById('hOut-slider'), text: document.getElementById('hOut-text') },
            altitude: { slider: document.getElementById('altitude-slider'), text: document.getElementById('altitude-text') },
            flowRate: { slider: document.getElementById('flowRate-slider'), text: document.getElementById('flowRate-text') }
        };

        const outputs = {
            altitudeDisplay: document.getElementById('altitude-display'),
            pressureDisplay: document.getElementById('pressure-display'),
            densityDisplay: document.getElementById('density-display'),
            decision: {
                container: document.getElementById('decision-container'),
                iconContainer: document.getElementById('decision-icon-container'),
                status: document.getElementById('decision-status'),
                message: document.getElementById('decision-message'),
            },
            weather: {
                btn: document.getElementById('fetch-weather-btn'),
                status: document.getElementById('weather-status-message'),
            },
            startBtn: document.getElementById('start-evaluation-btn'), // Bleibt hier, falls es einen JS-Fehler gäbe
            resultsColumn: document.getElementById('results-column'),
            water: {
                m3: document.getElementById('water-m3'),
                hContainer: document.getElementById('water-h-container'),
                h: document.getElementById('water-h'),
                hSubtext: document.getElementById('water-h-subtext'),
            },
            tm: {
                value: document.getElementById('tm-value'),
                bar: document.getElementById('tm-bar'),
                subtext: document.getElementById('tm-subtext'), 
            },
            history: {
                saveBtn: document.getElementById('save-measurement-btn'),
                clearBtn: document.getElementById('clear-history-btn')
            }
        };
        
        // --- CHART.JS SETUP ---
        const ctx = document.getElementById('absFeuchteChart').getContext('2d');
        
        const createCurveDataset = (label, color, fill = false) => ({
            label: label,
            data: [],
            borderColor: color,
            backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
            borderWidth: label === '100% rF' ? 3 : 1.5, 
            fill: fill,
            pointRadius: 0,
            tension: 0.1
        });

        const absFeuchteChart = new Chart(ctx, {
            type: 'line', 
            data: {
                datasets: [
                    createCurveDataset('100% rF', 'rgb(59, 130, 246)', true), 
                    createCurveDataset('90% rF', 'rgb(107, 114, 128)'), 
                    createCurveDataset('80% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('70% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('60% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('50% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('40% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('30% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('20% rF', 'rgb(107, 114, 128)'),
                    createCurveDataset('10% rF', 'rgb(107, 114, 128)'),
                    
                    // Dataset für den Trocknungspfad (Punkte)
                    {
                        label: 'Trocknungspfad',
                        data: [], 
                        borderColor: '#10b981', 
                        backgroundColor: '#10b981',
                        borderWidth: 3,
                        fill: false,
                        pointRadius: 8, 
                        pointHoverRadius: 10,
                        tension: 0,
                        showLine: false // Die Linie wird jetzt durch die Annotation gezeichnet
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            filter: function(item, chart) {
                                return item.text === '100% rF' || item.text === 'Trocknungspfad';
                            }
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#fff',
                        titleColor: '#334155',
                        bodyColor: '#334155',
                        bodyFont: { weight: 'bold' },
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 10,
                        filter: function(tooltipItem) {
                            return tooltipItem.datasetIndex === 10;
                        },
                        callbacks: {
                            title: () => '',
                            label: function(context) {
                                let pointLabel = (context.dataIndex === 0) ? 'Zuluft' : 'Abluft';
                                let temp = `Temp: ${context.parsed.x.toFixed(1)}°C`;
                                let absHum = `Abs. Feuchte: ${context.parsed.y.toFixed(2)} g/m³`;
                                let relHumVal = context.raw.relHum;
                                let relHum = `Rel. Feuchte: ${relHumVal.toFixed(1)} %`;
                                
                                return [pointLabel, temp, absHum, relHum];
                            }
                        }
                    },
                    datalabels: {
                        display: (context) => {
                            if (context.datasetIndex > 9) return false;
                            return context.dataIndex === context.dataset.data.length - 1;
                        },
                        formatter: (value, context) => {
                            return `${100 - context.datasetIndex * 10} %`;
                        },
                        align: 'right', 
                        anchor: 'center',
                        color: (context) => context.dataset.borderColor, 
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        offset: 8, 
                        padding: 0
                    },
                    // NEU: Annotation Plugin für Pfeil
                    annotation: {
                        annotations: {
                            dryingPathArrow: {
                                type: 'arrow',
                                xMin: 20, // Platzhalter
                                yMin: 15, // Platzhalter
                                xMax: 20, // Platzhalter
                                yMax: 18, // Platzhalter
                                borderColor: '#10b981', // emerald-500
                                borderWidth: 3,
                                display: false, // Startet versteckt
                                arrowHeads: {
                                    end: {
                                        display: true,
                                        width: 8,
                                        length: 12
                                    }
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        type: 'linear',
                        min: 0, 
                        max: 32, 
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Temperatur (°C)'
                        },
                        grid: { 
                            color: '#e2e8f0',
                            dash: [3, 3] 
                        },
                        border: { display: false },
                    },
                    y: { 
                        min: 0, 
                        max: 50, 
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Abs. Feuchte (g/m³)'
                        },
                        grid: { 
                            drawTicks: false,
                            color: '#e2e8f0',
                            dash: [3, 3] 
                        },
                        border: { display: false },
                        ticks: {
                            padding: 10,
                            callback: (value) => `${value.toFixed(1)}`
                        },
                    }
                }
            }
        });

        // Verlaufs-Diagramm
        const historyCtx = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(historyCtx, {
            type: 'line',
            data: {
                labels: [], 
                datasets: [
                    {
                        label: 'Wasserentzug (g/m³)',
                        data: [],
                        borderColor: '#3b82f6', 
                        backgroundColor: '#3b82f6',
                        tension: 0.1,
                        yAxisID: 'yGM3',
                    },
                    {
                        label: 'TM-Gehalt (%)',
                        data: [],
                        borderColor: '#10b981', 
                        backgroundColor: '#10b981',
                        tension: 0.1,
                        yAxisID: 'yPercent',
                    },
                    {
                        label: 'Aussenluft (%rF)',
                        data: [],
                        borderColor: '#a855f7', 
                        backgroundColor: '#a855f7',
                        tension: 0.1,
                        yAxisID: 'yPercent',
                        hidden: true, 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        display: true,
                    },
                    yGM3: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'g/m³'
                        },
                        grid: {
                            drawOnChartArea: false, 
                        },
                    },
                    yPercent: {
                        type: 'linear',
                        position: 'right',
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: '%'
                        }
                    }
                }
            }
        });


        // --- HAUPTFUNKTION (ersetzt useMemo) ---

        function calculateResults() {
            // 1. Werte auslesen
            const tIn = parseFloat(inputs.tIn.text.value);
            const hIn = parseFloat(inputs.hIn.text.value);
            const tOut = parseFloat(inputs.tOut.text.value);
            const hOut = parseFloat(inputs.hOut.text.value);
            const altitude = parseFloat(inputs.altitude.text.value);
            const flowRate = parseFloat(inputs.flowRate.text.value);

            // 2. Berechnungen durchführen
            const pressure = getAirPressure(altitude);
            const density = getAirDensity(tIn, pressure, 0);

            const absIn = getAbsHumidity(tIn, hIn, pressure);
            const absOut = getAbsHumidity(tOut, hOut, pressure);
            
            const deltaX_kg = absOut - absIn;
            const waterPerM3 = deltaX_kg * density;
            const absIn_g_m3 = absIn * density;
            const absOut_g_m3 = absOut * density;

            const waterPerHour = flowRate > 0 ? (waterPerM3 / 1000) * flowRate * 3600 : 0;
            
            const tmEst = estimateTM(hOut);

            // 3. Entscheidungshilfe Logik
            let status = "wait";
            let message = "";
            let colorClass = "";
            let iconName = "alert-triangle";

            if (hIn > 90) { 
                status = "stop";
                message = "AUS: Aussenluft (Hein) > 90%. Gefahr der Rückbefeuchtung.";
                colorClass = "bg-red-50 text-red-700 border-red-200";
                iconName = "x-circle";
            }
            else if (waterPerM3 < 0.5) { 
                if (hOut <= 50) { 
                    status = "stop";
                    message = "AUS: Heu ist lagerfähig (Haus <= 50%). Gratulation!";
                    colorClass = "bg-green-50 text-green-700 border-green-200";
                    iconName = "check-circle";
                }
                else {
                    status = "stop";
                    message = `AUS: Geringer Wasserentzug (${waterPerM3.toFixed(1)} g/m³). Lüftungspause.`;
                    colorClass = "bg-red-50 text-red-700 border-red-200";
                    iconName = "x-circle";
                }
            }
            else if (hOut >= 70) { 
                status = "continuous";
                message = "DAUERBETRIEB: Gute Bedingungen, Heu ist noch feucht.";
                colorClass = "bg-green-50 text-green-700 border-green-200";
                iconName = "activity";
            }
            else {
                if (hIn > 70) { 
                   status = "interval";
                   message = "INTERVALL: Endtrocknung. Aussenluft mässig.";
                   colorClass = "bg-amber-50 text-amber-700 border-amber-200";
                   iconName = "trending-up";
                } else { 
                   status = "continuous";
                   message = "DAUERBETRIEB: Endtrocknung mit guter Aussenluft.";
                   colorClass = "bg-green-50 text-green-700 border-green-200";
                   iconName = "activity";
                }
            }
            
            // 4. Objekt zurückgeben
            return {
                tIn, hIn, tOut, hOut, altitude, flowRate, 
                pressure, density, waterPerM3, absIn_g_m3, absOut_g_m3, waterPerHour, tmEst, 
                status, message, colorClass, iconName 
            };
        }

        function renderUI(results) {
            // Header
            outputs.altitudeDisplay.textContent = `${results.altitude} m ü.M.`;
            outputs.pressureDisplay.textContent = `${Math.round(results.pressure)} hPa`;
            outputs.densityDisplay.textContent = `${results.density.toFixed(2)} kg/m³`;

            // Entscheidungskarte
            const baseClasses = "rounded-2xl p-6 border shadow-sm flex flex-col md:flex-row items-center justify-between gap-6 transition-colors duration-300";
            outputs.decision.container.className = `${baseClasses} ${results.colorClass}`;
            outputs.decision.status.textContent = results.status === 'continuous' ? "Dauerbetrieb" : (results.status === 'interval' ? "Intervallbetrieb" : "Lüfter Aus / Stop");
            outputs.decision.message.textContent = results.message;
            outputs.decision.iconContainer.innerHTML = `<i data-lucide="${results.iconName}" class="h-8 w-8"></i>`;
            
            // Wasserentzug
            outputs.water.m3.textContent = results.waterPerM3.toFixed(2);
            outputs.water.m3.className = `text-2xl font-bold ${results.waterPerM3 > 0 ? "text-blue-600" : "text-red-500"}`;
            if (results.flowRate > 0) {
                outputs.water.hContainer.style.display = 'block';
                outputs.water.h.textContent = results.waterPerHour.toFixed(1);
                outputs.water.hSubtext.textContent = `Bei ${results.flowRate} m³/s Luftstrom`;
            } else {
                outputs.water.hContainer.style.display = 'none';
            }

            // TM Gehalt
            if (results.hIn < results.hOut) {
                outputs.tm.value.textContent = `~${results.tmEst}`;
                outputs.tm.value.className = "text-2xl font-bold text-emerald-600"; 
                outputs.tm.bar.style.width = `${results.tmEst}%`;
                outputs.tm.subtext.textContent = "Basierend auf Gleichgewichtsfeuchte der Abluft";
                outputs.tm.subtext.className = "text-xs text-slate-400 mt-1"; 
            } else {
                outputs.tm.value.textContent = "N/A";
                outputs.tm.value.className = "text-2xl font-bold text-red-500"; 
                outputs.tm.bar.style.width = "0%";
                outputs.tm.subtext.textContent = "Zuluft zu feucht für Bestimmung";
                outputs.tm.subtext.className = "text-xs text-red-500 mt-1"; 
            }


            // Chart (Aktuell) - h-x-Diagramm
            const zuluftPoint = { x: results.tIn, y: results.absIn_g_m3, relHum: results.hIn };
            const abluftPoint = { x: results.tOut, y: results.absOut_g_m3, relHum: results.hOut };
            
            const minTemp = 0;
            const maxTemp = 32; 

            for (let i = 0; i <= 9; i++) {
                const relHum = 100 - (i * 10); 
                const curveData = generateRelHumidityCurve(relHum, minTemp, maxTemp, results.pressure);
                absFeuchteChart.data.datasets[i].data = curveData;
            }

            // Trocknungspfad (Punkte)
            absFeuchteChart.data.datasets[10].data = [zuluftPoint, abluftPoint];

            // NEU: Pfeil-Annotation aktualisieren
            const arrow = absFeuchteChart.options.plugins.annotation.annotations.dryingPathArrow;
            arrow.xMin = zuluftPoint.x;
            arrow.yMin = zuluftPoint.y;
            arrow.xMax = abluftPoint.x;
            arrow.yMax = abluftPoint.y;
            // Pfeil nur anzeigen, wenn Start- und Endpunkt nicht identisch sind
            arrow.display = (zuluftPoint.x !== abluftPoint.x || zuluftPoint.y !== abluftPoint.y);
            
            absFeuchteChart.update();
            
            lucide.createIcons();
        }

        function updateApp() {
            const results = calculateResults();
            renderUI(results);
        }

        // --- NEUE FUNKTIONEN: VERLAUF/PROTOKOLL ---

        function loadHistory() {
            const data = localStorage.getItem(HISTORY_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveHistory(historyData) {
            const limitedData = historyData.slice(-HISTORY_LIMIT);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(limitedData));
        }

        function renderHistoryChart() {
            const history = loadHistory();
            
            const labels = history.map(d => 
                new Date(d.timestamp).toLocaleTimeString('de-DE', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            );
            const waterData = history.map(d => d.waterPerM3 ? d.waterPerM3.toFixed(2) : null);
            const tmData = history.map(d => d.tmEst); // tmEst wird jetzt mit null gespeichert, falls ungültig
            const hInData = history.map(d => d.hIn);

            historyChart.data.labels = labels;
            historyChart.data.datasets[0].data = waterData; 
            historyChart.data.datasets[1].data = tmData; 
            historyChart.data.datasets[2].data = hInData; 
            historyChart.update();
        }

        function handleSaveClick() {
            const results = calculateResults(); 
            const history = loadHistory();
            
            // NEU: Alle Werte aufzeichnen
            const newMeasurement = {
                timestamp: new Date().toISOString(),
                tIn: results.tIn,
                hIn: results.hIn,
                tOut: results.tOut,
                hOut: results.hOut,
                waterPerM3: results.waterPerM3,
                tmEst: (results.hIn < results.hOut) ? parseFloat(results.tmEst) : null, 
            };

            history.push(newMeasurement);
            saveHistory(history);
            renderHistoryChart(); 
        }

        function handleClearClick() {
            saveHistory([]); 
            renderHistoryChart(); 
        }


        // --- NEUE FUNKTIONEN: WETTER-ABRUF ---

        async function handleFetchWeather() {
            const btn = outputs.weather.btn;
            const status = outputs.weather.status;

            btn.disabled = true;
            status.textContent = "Standort wird ermittelt...";
            
            if (!navigator.geolocation) {
                status.textContent = "Geolocation wird nicht unterstützt.";
                status.className += " text-red-500";
                btn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError);
        }

        async function onGeoSuccess(position) {
            const { latitude, longitude } = position.coords;
            const status = outputs.weather.status;
            status.textContent = "Wetterdaten werden geladen...";

            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`API-Fehler (${response.status})`);
                }
                const data = await response.json();

                const temp = data.current.temperature_2m;
                const hum = data.current.relative_humidity_2m;

                const tInMin = parseFloat(inputs.tIn.text.min);
                const tInMax = parseFloat(inputs.tIn.text.max);
                const clampedTemp = Math.max(tInMin, Math.min(tInMax, temp));

                const hInMin = parseFloat(inputs.hIn.text.min);
                const hInMax = parseFloat(inputs.hIn.text.max);
                const clampedHum = Math.max(hInMin, Math.min(hInMax, Math.round(hum))); 


                inputs.tIn.text.value = clampedTemp.toFixed(1);
                inputs.tIn.slider.value = clampedTemp;
                inputs.hIn.text.value = clampedHum;
                inputs.hIn.slider.value = clampedHum;

                // Abluft-Werte werden nicht mehr automatisch gesetzt,
                // da der Startwert jetzt 20/65 ist, nicht 0/10.
                // Der Benutzer kann sie manuell anpassen.
                
                // NEU: App sofort aktualisieren
                updateApp();

                status.textContent = `Erfolgreich: ${temp.toFixed(1)}°C, ${hum}%`;
                status.className = "text-xs text-green-600 text-center mt-2 h-4";
            } catch (error) {
                status.textContent = `Fehler: ${error.message}`;
                status.className = "text-xs text-red-500 text-center mt-2 h-4";
            } finally {
                outputs.weather.btn.disabled = false;
            }
        }

        function onGeoError(error) {
            const status = outputs.weather.status;
            status.textContent = `Fehler: ${error.message}`;
            status.className = "text-xs text-red-500 text-center mt-2 h-4";
            outputs.weather.btn.disabled = false;
        }

        // --- EVENT LISTENER ---

        function setupInputBinding(inputId, min, max) {
            if (!inputs[inputId] || !inputs[inputId].slider || !inputs[inputId].text) {
                console.error(`Bindungsfehler: Eingabeelemente für '${inputId}' nicht gefunden.`);
                return;
            }

            const slider = inputs[inputId].slider;
            const text = inputs[inputId].text;
            
            slider.addEventListener('input', () => {
                text.value = slider.value;
                updateApp(); // NEU: Automatische Neuberechnung
            });

            text.addEventListener('input', (e) => {
                // Nur aktualisieren, wenn es eine gültige Zahl ist (oder leer)
                const numValue = parseFloat(text.value);
                if (!isNaN(numValue)) {
                    slider.value = Math.max(min, Math.min(max, numValue));
                    updateApp(); // NEU: Automatische Neuberechnung
                } else if (e.target.value === "") {
                    // OK, während der Eingabe
                }
            });

            text.addEventListener('change', () => { // 'change' feuert beim Verlassen (Blur)
                let numValue = parseFloat(text.value);
                if (isNaN(numValue)) {
                    numValue = min; 
                }
                const clampedValue = Math.max(min, Math.min(max, numValue));
                text.value = clampedValue;
                slider.value = clampedValue;
                updateApp(); // NEU: Automatische Neuberechnung
            });
        }

        setupInputBinding('tIn', 0, 45);
        setupInputBinding('hIn', 10, 100);
        setupInputBinding('tOut', 0, 50);
        setupInputBinding('hOut', 10, 100);
        setupInputBinding('altitude', 0, 2500);
        setupInputBinding('flowRate', 0, 100);

        outputs.weather.btn.addEventListener('click', handleFetchWeather);
        outputs.history.saveBtn.addEventListener('click', handleSaveClick);
        outputs.history.clearBtn.addEventListener('click', handleClearClick);
        
        // "Auswertung starten" Button-Listener ENTFERNT

        // --- INITIALISIERUNG ---
        lucide.createIcons();
        renderHistoryChart();
        // updateApp(); // ENTFERNT: App startet jetzt im "Warte"-Zustand.
    
    }); 
    </script>

</body>
</html>