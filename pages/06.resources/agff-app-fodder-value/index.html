<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGFF Futterbewertung (Angereichert)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÆ</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBALE VARIABLEN ---
        let futterWerte = {}; 
        let aktuellesStadiumLabel = "Nicht bestimmt";
        let db, auth;
        const PB_NEL = 3.14; 
        const PB_PROTEIN = 50; 

        document.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            try {
                const gespName = localStorage.getItem('agffBeurteilerName');
                if (gespName) document.getElementById('personName').value = gespName;
                const gespProbe = localStorage.getItem('agffProbenNr');
                if (gespProbe) document.getElementById('probeNr').value = gespProbe;
            } catch (e) { console.warn("LocalStorage N/A", e); }
            
            initializeFirebase();
            loadAndParseCSV();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyBvPcqBRCVrCBy2GIdi1vN92IC49iGb0Ks",
                  authDomain: "agff-apps.firebaseapp.com",
                  projectId: "agff-apps",
                  storageBucket: "agff-apps.firebasestorage.app",
                  messagingSenderId: "963390091539",
                  appId: "1:963390091539:web:eff9117033c24eda21eae6"
                };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-agff-app-public';
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (firebaseConfig.apiKey) {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    if (initialToken) await signInWithCustomToken(auth, initialToken);
                    else await signInAnonymously(auth);
                    console.log("Firebase ready.");
                } else {
                    disableCloudButton("Keine Konfiguration");
                }
            } catch (error) {
                console.error("Firebase Error:", error);
                disableCloudButton("Verbindungsfehler");
            }
        }

        function disableCloudButton(msg) {
            const btn = document.getElementById('saveCloudButton');
            if(btn) {
                btn.disabled = true;
                btn.title = msg;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function loadAndParseCSV() {
            try {
                const response = await fetch('futterwerte.csv');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                parseCSV(csvText);
                showLoading(false);
            } catch (error) {
                console.error("CSV Fehler:", error);
                document.getElementById('loading-spinner').innerHTML = "<p class='text-red-600 font-bold'>Fehler: futterwerte.csv nicht gefunden.</p>";
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("CSV leer");
            const headers = lines[0].split(';').map(h => h.trim());
            
            const colIdx = {
                futterart: headers.findIndex(h => h.toLowerCase() === 'futterart'),
                bestand: headers.findIndex(h => h.toLowerCase() === 'bestand'),
                aufwuchs: headers.findIndex(h => h.toLowerCase() === 'aufwuchs'),
                stadium: headers.findIndex(h => h.toLowerCase() === 'stadium'),
                nel: headers.findIndex(h => h.toLowerCase().startsWith('nel')),
                nev: headers.findIndex(h => h.toLowerCase().startsWith('nev')),
                apde: headers.findIndex(h => h.toLowerCase().startsWith('apde')),
                apdn: headers.findIndex(h => h.toLowerCase().startsWith('apdn')),
                rp: headers.findIndex(h => h.toLowerCase().startsWith('rp')),
                rf: headers.findIndex(h => h.toLowerCase().startsWith('rf')),
                ndf: headers.findIndex(h => h.toLowerCase().startsWith('ndf')),
                adf: headers.findIndex(h => h.toLowerCase().startsWith('adf')),
                zucker: headers.findIndex(h => h.toLowerCase().startsWith('zucker')),
                vos: headers.findIndex(h => h.toLowerCase().startsWith('vos')),
                ra: headers.findIndex(h => h.toLowerCase().startsWith('ra'))
            };

            futterWerte = { erster: {}, folge: {} };

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                if (values.length < headers.length) continue;

                const futterartDE = values[colIdx.futterart]?.trim().toLowerCase();
                const aufwuchsDE = values[colIdx.aufwuchs]?.trim().toLowerCase();
                const bestand = values[colIdx.bestand]?.trim().toUpperCase();
                const stadium = values[colIdx.stadium]?.trim();

                let konservierung, aufwuchs;
                if (aufwuchsDE.includes('erster') || aufwuchsDE.startsWith('1')) aufwuchs = 'erster';
                else if (aufwuchsDE.includes('folge')) aufwuchs = 'folge';
                else continue;

                if (futterartDE.startsWith('gr√ºnfutter')) konservierung = 'greenfeed';
                else if (futterartDE.startsWith('silage')) konservierung = 'silage';
                else if (futterartDE.startsWith('d√ºrrfutter')) konservierung = 'hay';
                else continue;

                if (!bestand || !stadium) continue;
                if (!futterWerte[aufwuchs]) futterWerte[aufwuchs] = {};
                if (!futterWerte[aufwuchs][konservierung]) futterWerte[aufwuchs][konservierung] = {};
                if (!futterWerte[aufwuchs][konservierung][bestand]) futterWerte[aufwuchs][konservierung][bestand] = {};

                const getVal = (idx) => (idx === -1 || !values[idx]) ? 0 : parseFloat(values[idx].replace(',', '.')) || 0;

                futterWerte[aufwuchs][konservierung][bestand][stadium] = {
                    nel: getVal(colIdx.nel), nev: getVal(colIdx.nev), apde: getVal(colIdx.apde),
                    apdn: getVal(colIdx.apdn), rp: getVal(colIdx.rp), rf: getVal(colIdx.rf),
                    ndf: getVal(colIdx.ndf), adf: getVal(colIdx.adf), zucker: getVal(colIdx.zucker),
                    vos: getVal(colIdx.vos), ra: getVal(colIdx.ra)
                };
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('input[name="aufwuchs"]').forEach(r => r.addEventListener('change', () => {
                document.getElementById('step2-bestand').classList.remove('opacity-50', 'pointer-events-none');
                const lageWrapper = document.getElementById('step1-5-lage');
                r.value === 'folge' ? lageWrapper.classList.remove('hidden') : lageWrapper.classList.add('hidden');
                updateStadiumModalOptions(r.value);
            }));

            document.querySelectorAll('input[name="lage"]').forEach(r => r.addEventListener('change', () => {
                const aufwuchs = document.querySelector('input[name="aufwuchs"]:checked')?.value;
                if (aufwuchs) updateStadiumModalOptions(aufwuchs);
            }));

            document.getElementById('bestandestyp').addEventListener('change', (e) => {
                const step3 = document.getElementById('step3-stadium');
                e.target.value ? step3.classList.remove('opacity-50', 'pointer-events-none') : step3.classList.add('opacity-50', 'pointer-events-none');
                checkAllInputs();
            });
            
            document.getElementById('bestandHelpToggle').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('bestandHelpContent').classList.toggle('hidden');
            });

            document.getElementById('openStadiumModal').addEventListener('click', () => document.getElementById('stadiumModal').classList.remove('hidden'));
            document.getElementById('closeStadiumModal').addEventListener('click', () => document.getElementById('stadiumModal').classList.add('hidden'));

            document.getElementById('stadium-options').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    aktuellesStadiumLabel = e.target.textContent;
                    const btn = document.getElementById('openStadiumModal');
                    btn.textContent = aktuellesStadiumLabel;
                    btn.dataset.selectedStadium = e.target.dataset.stadium;
                    document.getElementById('stadiumModal').classList.add('hidden');
                    checkAllInputs();
                }
            });
            
            document.getElementById('toggleStadiumHelp').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('stadiumHelpContent').classList.toggle('hidden');
            });
            
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImg = document.getElementById('lightboxImage');
            document.getElementById('stadiumHelpContent').addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG' && e.target.closest('figure')) {
                    lightboxImg.src = e.target.src;
                    lightbox.classList.remove('hidden');
                }
            });
            lightbox.addEventListener('click', () => {
                lightbox.classList.add('hidden');
                lightboxImg.src = '';
            });

            document.querySelectorAll('input[name="konservierung"]').forEach(r => r.addEventListener('click', calculateFutterQualitaet));

            document.getElementById('accordion-toggle').addEventListener('click', () => {
                document.getElementById('accordion-content').classList.toggle('hidden');
                document.getElementById('accordion-icon').classList.toggle('rotate-180');
            });
            document.getElementById('data-accordion-toggle').addEventListener('click', () => {
                document.getElementById('data-accordion-content').classList.toggle('hidden');
                document.getElementById('data-accordion-icon').classList.toggle('rotate-180');
            });

            const paramIds = ['kuhgewicht', 'tsvOverride', 'check_ration_silage', 'check_ration_hay'];
            paramIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', () => {
                    if (!document.getElementById('result-wrapper').classList.contains('hidden')) applyCorrections();
                });
            });
            
            document.getElementById('personName').addEventListener('input', (e) => localStorage.setItem('agffBeurteilerName', e.target.value));
            document.getElementById('probeNr').addEventListener('input', (e) => localStorage.setItem('agffProbenNr', e.target.value));

            document.getElementById('savePdfButton').addEventListener('click', handleSavePdf);
            
            // --- NEU: Button-Logik f√ºr Dropdown und Speichern ---
            document.getElementById('saveCloudButton').addEventListener('click', handleSaveCloud);
            document.getElementById('saveJsonButton').addEventListener('click', handleSaveJson);
            
            // Dropdown Toggle
            const dropTrigger = document.getElementById('dropdownTrigger');
            const dropMenu = document.getElementById('saveDropdownMenu');
            
            dropTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                dropMenu.classList.toggle('hidden');
            });

            // Schliessen wenn ausserhalb geklickt wird
            document.addEventListener('click', (e) => {
                if (!dropTrigger.contains(e.target) && !dropMenu.contains(e.target)) {
                    dropMenu.classList.add('hidden');
                }
            });
        }

        function showLoading(isLoading) {
            const spinner = document.getElementById('loading-spinner');
            const mainContent = document.getElementById('main-content');
            isLoading ? (spinner.classList.remove('hidden'), mainContent.classList.add('hidden')) : (spinner.classList.add('hidden'), mainContent.classList.remove('hidden'));
        }

        function updateStadiumModalOptions(aufwuchsart) {
            const container = document.getElementById('stadium-options');
            container.innerHTML = '';
            const btn = document.getElementById('openStadiumModal');
            btn.textContent = 'Stadium jetzt bestimmen...';
            btn.dataset.selectedStadium = '';
            checkAllInputs();
            
            document.getElementById('stadiumHelpContent').classList.add('hidden');
            document.getElementById('stadiumModalSubtitle').textContent = "";
            document.getElementById('folgeHinweisContainer').innerHTML = '';

            let options = [];
            if (aufwuchsart === 'erster') {
                document.getElementById('toggleStadiumHelp').classList.remove('hidden');
                options = [1,2,3,4,5,6,7].map(i => ({val: i, label: `Stadium ${i}`}));
                options[0].label += " (Bestockung / Beginn Schossen)";
                options[1].label += " (Schossen / Weidestadium)";
                options[2].label += " (Beginn Rispenschieben)";
                options[3].label += " (Volles Rispenschieben)";
                options[4].label += " (Ende Rispenschieben)";
                options[5].label += " (Bl√ºte)";
                options[6].label += " (Samenreife)";
                document.getElementById('stadiumModalTitle').textContent = "Stadium 1. Aufwuchs (Leitpflanze)";
            } else {
                document.getElementById('toggleStadiumHelp').classList.add('hidden');
                document.getElementById('folgeHinweisContainer').innerHTML = `<div class="p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg border border-yellow-200"><strong>Hinweis:</strong> Bei viel Raigras gilt das Stadium der Leitpflanze (wie 1. Aufwuchs).</div>`;
                const lage = document.querySelector('input[name="lage"]:checked')?.value || 'tal';
                document.getElementById('stadiumModalTitle').textContent = "Stadium Folgeaufwuchs (Alter)";
                
                if (lage === 'tal') {
                    document.getElementById('stadiumModalSubtitle').textContent = "Talgebiet (bis 600m), Sommer (Juli-Aug)";
                    options = [
                        {val:'1', label:'3 Wochen (1 sehr fr√ºh)'}, {val:'2', label:'4 Wochen (2 fr√ºh)'},
                        {val:'3', label:'5-6 Wochen (3 mittelfr√ºh)'}, {val:'4', label:'7-8 Wochen (4 mittel)'},
                        {val:'5', label:'9-10 Wochen (5 mittelsp√§t)'}, {val:'6', label:'11+ Wochen (6 sp√§t)'}
                    ];
                } else {
                    document.getElementById('stadiumModalSubtitle').textContent = "Berggebiet (>600m) oder Herbst (ab Sept)";
                    options = [
                        {val:'1', label:'3-4 Wochen (1 sehr fr√ºh)'}, {val:'2', label:'5-7 Wochen (2 fr√ºh)'},
                        {val:'3', label:'8-9 Wochen (3 mittelfr√ºh)'}, {val:'4', label:'10+ Wochen (4 mittel)'}
                    ];
                }
            }

            options.forEach(opt => {
                const b = document.createElement('button');
                b.type = 'button';
                b.dataset.stadium = opt.val;
                b.textContent = opt.label;
                b.className = 'w-full text-left p-3 bg-gray-50 hover:bg-green-100 rounded-lg transition-colors';
                container.appendChild(b);
            });
        }

        function checkAllInputs() {
            const aufwuchs = document.querySelector('input[name="aufwuchs"]:checked');
            const bestand = document.getElementById('bestandestyp').value;
            const stadium = document.getElementById('openStadiumModal').dataset.selectedStadium;
            const btns = document.getElementById('step4-calculate-buttons');
            (aufwuchs && bestand && stadium) ? btns.classList.remove('opacity-50', 'pointer-events-none') : btns.classList.add('opacity-50', 'pointer-events-none');
        }

        function calculateFutterQualitaet() {
            const aufwuchs = document.querySelector('input[name="aufwuchs"]:checked')?.value;
            const bestand = document.getElementById('bestandestyp').value;
            const stadium = document.getElementById('openStadiumModal').dataset.selectedStadium;
            const konservierung = document.querySelector('input[name="konservierung"]:checked')?.value;

            if (!aufwuchs || !bestand || !stadium || !konservierung) return;
            
            const werte = futterWerte[aufwuchs]?.[konservierung]?.[bestand]?.[stadium];
            if (!werte) {
                const rw = document.getElementById('result-wrapper');
                rw.classList.remove('hidden');
                document.getElementById('result-content').innerHTML = '<p class="text-red-500">Keine Referenzdaten f√ºr diese Kombination gefunden.</p>';
                document.getElementById('step5-corrections').classList.add('hidden');
                document.getElementById('report-buttons').classList.add('hidden');
                return;
            }

            const wrapper = document.getElementById('result-wrapper');
            Object.keys(werte).forEach(k => wrapper.dataset[`base${k.charAt(0).toUpperCase() + k.slice(1)}`] = werte[k]);

            wrapper.classList.remove('hidden');
            document.getElementById('report-buttons').classList.remove('hidden');
            generateCorrectionInputs(konservierung);
            
            const checkSilage = document.getElementById('check_ration_silage');
            const checkHay = document.getElementById('check_ration_hay');

            if(checkSilage) checkSilage.checked = false;
            if(checkHay) checkHay.checked = false;

            if (konservierung === 'silage') {
                if(checkSilage) checkSilage.checked = true;
            } else if (konservierung === 'hay') {
                if(checkHay) checkHay.checked = true;
            }

            applyCorrections();
        }

        function applyCorrections() {
            const w = document.getElementById('result-wrapper');
            const base = {
                nel: parseFloat(w.dataset.baseNel), nev: parseFloat(w.dataset.baseNev),
                apde: parseFloat(w.dataset.baseApde), apdn: parseFloat(w.dataset.baseApdn),
                rp: parseFloat(w.dataset.baseRp), rf: parseFloat(w.dataset.baseRf),
                ndf: parseFloat(w.dataset.baseNdf), adf: parseFloat(w.dataset.baseAdf),
                zucker: parseFloat(w.dataset.baseZucker), vos: parseFloat(w.dataset.baseVos),
                ra: parseFloat(w.dataset.baseRa)
            };
            
            if (isNaN(base.nel) || base.nel === 0) return;

            let factors = { nel: 1, apde: 1, apdn: 1 };
            let tsvCorrectionsSum = 0;
            let labels = [];
            
            document.querySelectorAll('#correction-inputs input:checked').forEach(cb => {
                factors.nel *= (1 + parseFloat(cb.dataset.nel));
                factors.apde *= (1 + parseFloat(cb.dataset.apde));
                factors.apdn *= (1 + parseFloat(cb.dataset.apdn));
                tsvCorrectionsSum += parseFloat(cb.dataset.tsv || 0); 
                labels.push(cb.dataset.label);
            });
            
            const rationSilage = document.getElementById('check_ration_silage');
            if (rationSilage && rationSilage.checked) {
                tsvCorrectionsSum += parseFloat(rationSilage.dataset.tsv);
                labels.push("Ration: Hoher Silageanteil");
            }
            const rationHay = document.getElementById('check_ration_hay');
            if (rationHay && rationHay.checked) {
                tsvCorrectionsSum += parseFloat(rationHay.dataset.tsv);
                labels.push("Technik: F√ºtterungsbeginn Heu");
            }

            const eff = {
                nel: base.nel * factors.nel,
                nev: base.nev * factors.nel,
                apde: base.apde * factors.apde,
                apdn: base.apdn * factors.apdn
            };

            const nelAbweichung = (eff.nel - 5.6) / 0.1;
            const tsvKorrEnergie = nelAbweichung * 0.3;

            const inputGewicht = parseFloat(document.getElementById('kuhgewicht').value) || 650;
            const gewichtAbweichung = (inputGewicht - 650) / 10;
            const tsvKorrGewicht = gewichtAbweichung * 0.1;

            const automatischTSV = 16.0 + tsvKorrEnergie + tsvKorrGewicht + tsvCorrectionsSum;

            const override = parseFloat(document.getElementById('tsvOverride').value);
            const effTSV = (isNaN(override) || override <= 0) ? automatischTSV : override;

            const { mpp, limit } = calculateMpp(eff, effTSV, inputGewicht);
            displayResults(base, eff, effTSV, automatischTSV, mpp, limit, labels);
        }

        function calculateMpp(eff, tsv, gewicht) {
            const ebNel = (0.293 * Math.pow(gewicht, 0.75)) * 1.1;
            const ebProt = (3.25 * Math.pow(gewicht, 0.75)) * 1.1;
            
            const mppNel = ((eff.nel * tsv) - ebNel) / PB_NEL;
            const mppApde = ((eff.apde * tsv) - ebProt) / PB_PROTEIN;
            const mppApdn = ((eff.apdn * tsv) - ebProt) / PB_PROTEIN;

            const mpp = Math.max(0, Math.min(mppNel, mppApde, mppApdn));
            let limit = "NEL";
            if (mppApde < mppNel && mppApde < mppApdn) limit = "APDE";
            if (mppApdn < mppNel && mppApdn < mppApde) limit = "APDN";
            return { mpp, limit };
        }

        function displayResults(base, eff, tsv, autoTSV, mpp, limit, labels) {
            const row = (l, b, e, u, bold) => {
                const k = e - b;
                const kTxt = k === 0 ? '-' : (k > 0 ? `+${k.toFixed(2)}` : k.toFixed(2));
                return `<tr class="${bold?'font-bold':''}">
                    <td class="py-2 pr-2">${l}</td>
                    <td class="py-2 px-2 text-right">${b.toFixed(2)}</td>
                    <td class="py-2 px-2 text-right ${k!==0?(k>0?'text-green-600':'text-red-600'):''}">${kTxt}</td>
                    <td class="py-2 pl-2 text-right"><span id="eff-${l.toLowerCase()}">${e.toFixed(2)}</span></td>
                    <td class="py-2 pl-2 text-gray-500">${u}</td></tr>`;
            };

            const tsvDiff = tsv - autoTSV;
            const tsvRow = `<tr>
                <td class="py-2 pr-2">Futterverzehr (TSV)</td>
                <td class="py-2 px-2 text-right" title="Basisberechnung">${autoTSV.toFixed(2)}</td>
                <td class="py-2 px-2 text-right ${Math.abs(tsvDiff)>0.05 ? 'text-blue-600' : ''}">${Math.abs(tsvDiff)>0.05 ? (tsvDiff>0?'+':'')+tsvDiff.toFixed(2) : '-'}</td>
                <td class="py-2 pl-2 text-right">${tsv.toFixed(2)}</td>
                <td class="py-2 pl-2 text-gray-500">kg TS</td></tr>`;

            document.getElementById('result-content').innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Berechnete Futterqualit√§t</h3>
                <div class="overflow-x-auto"><table class="w-full min-w-[340px] text-sm">
                <thead><tr class="border-b"><th class="text-left py-2">Parameter</th><th class="text-right py-2">Basis</th><th class="text-right py-2">Korr.</th><th class="text-right py-2">Effektiv</th><th class="text-left py-2">Einh.</th></tr></thead>
                <tbody>
                    ${row('NEL', base.nel, eff.nel, 'MJ/kg', limit==='NEL')}
                    ${row('APDE', base.apde, eff.apde, 'g/kg', limit==='APDE')}
                    ${row('APDN', base.apdn, eff.apdn, 'g/kg', limit==='APDN')}
                    ${row('NEV', base.nev, eff.nev, 'MJ/kg')}
                    ${tsvRow}
                </tbody></table></div>
                <div class="mt-4 p-4 bg-green-50 rounded-lg">
                    <p class="text-sm text-green-700">MPP (Potenzial):</p>
                    <p class="text-3xl font-bold text-green-800">${mpp.toFixed(1)} kg ECM/Tag</p>
                    <p class="text-sm text-gray-600 mt-1">Limitiert durch: <span class="font-semibold">${limit}</span></p>
                </div>
                <h4 class="text-lg font-semibold text-gray-800 mt-6 mb-3">Weitere N√§hrwerte (Basis)</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    ${[['Rohprotein',base.rp,'g/kg'],['Rohfaser',base.rf,'g/kg'],['NDF',base.ndf,'g/kg'],['ADF',base.adf,'g/kg'],['Zucker',base.zucker,'g/kg'],['vOS',base.vos,'%'],['Rohasche',base.ra,'g/kg']].map(x=>`<div class="p-2 bg-gray-50 rounded"><span class="font-medium">${x[0]}:</span> ${x[1].toFixed(0)} ${x[2]}</div>`).join('')}
                </div>
                ${labels.length?`<div class="mt-6"><h4 class="font-semibold text-gray-700">Angewendete Faktoren:</h4><ul class="list-disc list-inside text-sm text-red-600 pl-2">${labels.map(l=>`<li>${l}</li>`).join('')}</ul></div>`:''}
            `;
        }

        function generateCorrectionInputs(konservierung) {
            const container = document.getElementById('correction-inputs');
            container.innerHTML = '';
            const wrapper = document.getElementById('step5-corrections');
            
            const map = {
                silage: [ 
                    { id: "ts_low", label: "TS < 20%", nel: -0.01, apde: -0.06, apdn: 0, tsv: 0 },
                    { id: "ts_high", label: "TS > 50%", nel: -0.01, apde: 0.06, apdn: 0.05, tsv: 0 },
                    { id: "gaer_bad", label: "G√§rqualit√§t fehlerhaft", nel: -0.02, apde: -0.06, apdn: -0.05, tsv: -1.0 },
                    { id: "gaer_vbad", label: "G√§rqualit√§t schlecht", nel: -0.05, apde: -0.15, apdn: -0.12, tsv: -2.0 },
                    { id: "nachgaer", label: "Nachg√§rung (leicht warm)", nel: -0.04, apde: -0.15, apdn: -0.03, tsv: -1.0 }
                ],
                hay: [ 
                    { id: "boden", label: "Bodentrocknung", nel: -0.04, apde: -0.03, apdn: 0, tsv: 0 },
                    { id: "regen_1", label: "Witterung: 1 Tag Regen", nel: -0.05, apde: -0.08, apdn: -0.02, tsv: 0 },
                    { id: "regen_2", label: "Witterung: 2+ Tage Regen", nel: -0.08, apde: -0.15, apdn: -0.03, tsv: 0 },
                    { id: "ueber_leicht", label: "√úberhitzung: leicht braun", nel: 0, apde: 0.03, apdn: 0, tsv: 0 },
                    { id: "ueber_stark", label: "√úberhitzung: braun/brandig", nel: -0.05, apde: -0.01, apdn: -0.02, tsv: 0 }
                ]
            };
            const list = map[konservierung];
            if (!list) { wrapper.classList.add('hidden'); return; }

            wrapper.classList.remove('hidden');
            list.forEach(f => {
                const l = document.createElement('label');
                l.className = 'flex items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50 cursor-pointer';
                
                let infoText = "";
                if (Math.abs(f.nel) > 0) infoText += `NEL: ${Math.round(f.nel*100)}% `;
                if (f.tsv !== 0) infoText += `Verzehr: ${f.tsv > 0 ? '+' : ''}${f.tsv}kg`;
                if (infoText === "") infoText = "Kleine Korrektur";

                l.innerHTML = `<input type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500" 
                                data-nel="${f.nel}" data-apde="${f.apde}" data-apdn="${f.apdn}" data-tsv="${f.tsv}" data-label="${f.label}">
                               <span class="ml-3 text-sm text-gray-700 flex-1">${f.label} <span class="text-xs text-gray-500 block md:inline md:ml-2">(${infoText})</span></span>`;
                l.querySelector('input').addEventListener('change', applyCorrections);
                container.appendChild(l);
            });
        }

        async function handleSavePdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = getResultData();
            if(!data) return;
            
            doc.setFontSize(18); doc.text("Futterbewertungs-Bericht", 105, 20, {align:'center'});
            doc.setFontSize(12); doc.text(`Erstellt: ${new Date().toLocaleString()}`, 105, 30, {align:'center'});
            
            let y = 50;
            const print = (txt, val) => { doc.text(`${txt}: ${val}`, 20, y); y+=10; };
            
            print("Beurteiler", document.getElementById('personName').value);
            print("Aufwuchs", document.querySelector('input[name="aufwuchs"]:checked')?.value);
            print("Bestand", document.getElementById('bestandestyp').options[document.getElementById('bestandestyp').selectedIndex].text);
            print("Stadium", aktuellesStadiumLabel);
            print("Konservierung", document.querySelector('input[name="konservierung"]:checked')?.dataset.label);
            y+=10;
            print("TS-Verzehr", `${data.tsv.toFixed(2)} kg`);
            print("MPP", `${data.mpp.toFixed(1)} kg ECM (${data.limit})`);
            
            doc.save('Futterbericht.pdf');
        }

        // --- NEU: JSON Download Funktion ---
        async function handleSaveJson() {
            const data = getResultData();
            if (!data) {
                alert("Bitte f√ºhren Sie zuerst eine Berechnung durch.");
                return;
            }
            
            const probeNr = document.getElementById('probeNr').value.trim();
            if (!probeNr) {
                alert("Bitte geben Sie eine Probenummer ein.");
                document.getElementById('probeNr').focus();
                return;
            }
            
            const beurteiler = document.getElementById('personName').value;
            
            // Aktuelle Eingaben sammeln
            const inputData = {
                beurteiler: beurteiler,
                probeNr: probeNr,
                aufwuchs: document.querySelector('input[name="aufwuchs"]:checked')?.value,
                bestand: document.getElementById('bestandestyp').value,
                stadiumLabel: aktuellesStadiumLabel,
                konservierung: document.querySelector('input[name="konservierung"]:checked')?.value,
                kuhGewicht: document.getElementById('kuhgewicht').value,
                tsvOverride: document.getElementById('tsvOverride').value
            };
            
            // Gesamtdaten
            const exportData = {
                meta: {
                    erstelltAm: new Date().toISOString(),
                    app: "AGFF Futterbewertung"
                },
                eingaben: inputData,
                ergebnisse: data
            };
            
            // Download ausl√∂sen
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Futterwert_${probeNr.replace(/[^a-z0-9]/gi, '_')}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            // Dropdown schlie√üen
            document.getElementById('saveDropdownMenu').classList.add('hidden');
        }

        async function handleSaveCloud() {
            if (!db || !auth.currentUser) return;
            const data = getResultData();
            if(!data) return;
            const btn = document.getElementById('saveCloudButton');
            btn.textContent = "Speichern...";

            // --- Check 1: Leeres Feld ---
            const probeNr = document.getElementById('probeNr').value.trim();
            if (!probeNr) {
                alert("Bitte geben Sie eine Probenummer ein.");
                document.getElementById('probeNr').focus();
                btn.textContent = "In Cloud speichern";
                btn.disabled = false;
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-agff-app-public';
            const collectionPath = `artifacts/${appId}/public/data/futterproben`;
            const collectionRef = collection(db, collectionPath);

            try {
                // --- Check 2: Duplikat in Cloud ---
                const q = query(collectionRef, where("probeNr", "==", probeNr));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    alert("Eine Probe mit dieser Nummer existiert bereits. Bitte w√§hlen Sie eine andere Probenummer.");
                    btn.textContent = "In Cloud speichern";
                    btn.disabled = false;
                    return;
                }

                const payload = {
                    beurteiler: document.getElementById('personName').value,
                    probeNr: probeNr,
                    mpp: data.mpp,
                    tsv: data.tsv,
                    erstelltAm: serverTimestamp(),
                    userId: auth.currentUser.uid
                };
                await addDoc(collectionRef, payload);
                btn.textContent = "Gespeichert!";
                setTimeout(() => btn.textContent = "In Cloud speichern", 2000);
            } catch (e) { 
                console.error(e); 
                btn.textContent = "Fehler"; 
                alert("Fehler beim Speichern: " + e.message);
            }
        }
        
        function getResultData() {
             const rw = document.getElementById('result-wrapper');
             if(rw.classList.contains('hidden')) return null;
             const mppText = document.querySelector('#result-content .text-3xl')?.textContent;
             const limitText = document.querySelector('#result-content .font-semibold')?.textContent;
             const tsvText = document.querySelectorAll('#result-content tr')[4]?.querySelectorAll('td')[3]?.textContent;
             return {
                 mpp: parseFloat(mppText) || 0,
                 limit: limitText,
                 tsv: parseFloat(tsvText) || 0
             }
        }

    </script>

    <style>
        .tooltip-table td { padding: 2px 8px; border-bottom: 1px solid #eee; }
        .tooltip-table tr:last-child td { border-bottom: none; }
        .tooltip-header { font-weight: bold; color: #166534; margin-top: 8px; margin-bottom: 4px; font-size: 0.9em; }
        .tooltip-val { text-align: right; font-family: monospace; font-weight: bold; }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin h-10 w-10 border-4 border-green-600 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-gray-600">Lade App-Daten...</p>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üêÆ</span>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">Futterwert-Sch√§tzung</h1>
                        <p class="text-xs text-gray-500">Nach AGFF Merkblatt Nr. 3</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 grid md:grid-cols-2 gap-6">
            
            <div class="space-y-4">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 space-y-3">
                    <h2 class="font-semibold text-gray-700 border-b pb-2">Probe-Informationen</h2>
                    <input type="text" id="personName" placeholder="Name Beurteiler" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none">
                    <input type="text" id="probeNr" placeholder="Probenr. oder Betriebsnummer/Parzelle/Jahr/Schnitt" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <label class="font-semibold text-gray-700 block mb-2">1. Aufwuchsart</label>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <label class="flex-1 text-center cursor-pointer py-2 rounded hover:bg-white hover:shadow transition-all">
                            <input type="radio" name="aufwuchs" value="erster" class="hidden peer">
                            <span class="peer-checked:text-green-700 peer-checked:font-bold">1. Aufwuchs</span>
                        </label>
                        <label class="flex-1 text-center cursor-pointer py-2 rounded hover:bg-white hover:shadow transition-all">
                            <input type="radio" name="aufwuchs" value="folge" class="hidden peer">
                            <span class="peer-checked:text-green-700 peer-checked:font-bold">Folgeaufwuchs</span>
                        </label>
                    </div>
                    
                    <div id="step1-5-lage" class="hidden mt-3 pt-3 border-t">
                        <p class="text-sm font-medium text-gray-600 mb-2">Lage (f√ºr Folgeaufwuchs)</p>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="lage" value="tal" checked class="text-green-600 focus:ring-green-500">
                                <span class="text-sm">Talgebiet (Sommer)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="lage" value="berg" class="text-green-600 focus:ring-green-500">
                                <span class="text-sm">Berggebiet / Herbst</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="step2-bestand" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 opacity-50 pointer-events-none transition-all">
                    <div class="flex justify-between">
                        <label class="font-semibold text-gray-700">2. Bestandestyp</label>
                        <button id="bestandHelpToggle" class="text-xs text-blue-600 font-medium">Hilfe</button>
                    </div>
                    <div id="bestandHelpContent" class="hidden text-sm bg-blue-50 p-3 rounded mt-2 text-blue-800">
                        <ul class="list-disc pl-4 space-y-1">
                            <li><strong>G/GR:</strong> > 70% Gr√§ser</li>
                            <li><strong>A/AR:</strong> 50-70% Gr√§ser</li>
                            <li><strong>L:</strong> > 50% Klee</li>
                            <li><strong>KF/KG:</strong> > 50% Kr√§uter</li>
                        </ul>
                    </div>
                    <select id="bestandestyp" class="w-full mt-2 p-2 border rounded focus:ring-2 focus:ring-green-500 bg-white">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="G">G: Gr√§serreich</option>
                        <option value="GR">GR: Gr√§serreich (Raigras)</option>
                        <option value="A">A: Ausgewogen</option>
                        <option value="AR">AR: Ausgewogen (Raigras)</option>
                        <option value="L">L: Leguminosenreich</option>
                        <option value="KF">KF: Kr√§uterreich (fein)</option>
                        <option value="KG">KG: Kr√§uterreich (grob)</option>
                    </select>
                </div>

                <div id="step3-stadium" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 opacity-50 pointer-events-none transition-all">
                    <label class="font-semibold text-gray-700 block mb-2">3. Entwicklungsstadium</label>
                    <button id="openStadiumModal" type="button" class="w-full text-left p-2 border rounded bg-white hover:bg-gray-50 focus:ring-2 focus:ring-green-500">
                        Bitte w√§hlen...
                    </button>
                </div>

                <div id="step4-calculate-buttons" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 opacity-50 pointer-events-none transition-all space-y-3">
                    <label class="font-semibold text-gray-700 block">4. Konservierung & Berechnen</label>
                    <div class="grid grid-cols-1 gap-3">
                        <label class="flex items-center justify-center p-3 rounded bg-green-600 text-white font-bold cursor-pointer hover:bg-green-700 shadow">
                            <input type="radio" name="konservierung" value="greenfeed" class="hidden">
                            <span>üçÄ Gr√ºnfutter berechnen</span>
                        </label>
                        <label class="flex items-center justify-center p-3 rounded bg-blue-600 text-white font-bold cursor-pointer hover:bg-blue-700 shadow">
                            <input type="radio" name="konservierung" value="silage" data-label="Silage" class="hidden">
                            <span>‚ö™ Silage berechnen</span>
                        </label>
                        <label class="flex items-center justify-center p-3 rounded bg-yellow-500 text-white font-bold cursor-pointer hover:bg-yellow-600 shadow">
                            <input type="radio" name="konservierung" value="hay" data-label="D√ºrrfutter" class="hidden">
                            <span>üü® D√ºrrfutter berechnen</span>
                        </label>
                    </div>
                </div>

            </div>

            <div class="space-y-6">
                
                <div id="result-wrapper" class="bg-white p-5 rounded-xl shadow-lg border border-green-100 hidden">
                    <div id="result-content"></div> 
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <button id="accordion-toggle" class="w-full flex justify-between items-center p-4 font-semibold text-gray-700">
                        <div class="flex items-center gap-2">
                            <span>Optionale Berechnungsparameter</span>
                            
                            <div class="relative group inline-block cursor-help">
                                <div class="bg-gray-200 text-gray-600 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">?</div>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-80 md:w-96 bg-white border border-gray-300 text-gray-700 text-xs rounded-lg shadow-2xl z-50 p-4">
                                    <h4 class="text-sm font-bold text-gray-900 border-b pb-1 mb-2">Sch√§tzung Grundfutterverzehr (Basis: 16 kg TS)</h4>
                                    
                                    <div class="tooltip-header">Tier</div>
                                    <table class="w-full tooltip-table">
                                        <tr><td>Galtphase</td><td class="tooltip-val">-1.0</td></tr>
                                        <tr><td>Lebendgewicht (√ò 650kg ¬±10kg)</td><td class="tooltip-val">¬±0.1</td></tr>
                                        <tr><td>Milchleistung (√ò 7000kg ¬±100kg)</td><td class="tooltip-val">¬±0.1</td></tr>
                                        <tr><td>BCS > 4 (sehr fett)</td><td class="tooltip-val">-1.0</td></tr>
                                    </table>

                                    <div class="tooltip-header">F√ºtterungstechnik</div>
                                    <table class="w-full tooltip-table">
                                        <tr><td>Rund um die Uhr</td><td class="tooltip-val">+1.0</td></tr>
                                        <tr><td>Unter 7 Std. pro Tag</td><td class="tooltip-val">-0.5</td></tr>
                                        <tr><td>Krippenreste (stets viel)</td><td class="tooltip-val">+0.5</td></tr>
                                        <tr><td>Krippenreste (kaum)</td><td class="tooltip-val">-0.5</td></tr>
                                    </table>

                                    <div class="tooltip-header">Futterration</div>
                                    <table class="w-full tooltip-table">
                                        <tr><td>Anteil Maissilage > 1/3</td><td class="tooltip-val">-0.5</td></tr>
                                        <tr><td>Gesamtsilage > 3/4</td><td class="tooltip-val">-1.0</td></tr>
                                        <tr><td>> 5kg R√ºben/Kartoffeln/Obst</td><td class="tooltip-val">+0.5</td></tr>
                                    </table>

                                    <div class="tooltip-header">Schlechte Struktur</div>
                                    <table class="w-full tooltip-table">
                                        <tr><td>Gr√ºnf./Silage sehr jung/nass</td><td class="tooltip-val">-1.0</td></tr>
                                        <tr><td>Zerst√∂rte Struktur (H√§ckselgut)</td><td class="tooltip-val">-1.0</td></tr>
                                    </table>

                                    <div class="tooltip-header">Energiekonzentration</div>
                                    <table class="w-full tooltip-table">
                                        <tr><td>√ò NEL-Gehalt 5.6 MJ (¬±0.1)</td><td class="tooltip-val">¬±0.3</td></tr>
                                    </table>
                                    
                                    <div class="mt-2 pt-2 border-t text-[10px] text-gray-500 italic">
                                        Werte in kg Trockensubstanz pro Tag. Quelle: AGFF Merkblatt.
                                    </div>
                                </div>
                            </div>

                        </div>
                        <svg id="accordion-icon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    
                    <div id="accordion-content" class="hidden p-4 border-t border-gray-100 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kuhgewicht (LG) in kg</label>
                            <input type="number" id="kuhgewicht" value="650" class="w-full p-2 border rounded focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Standardwert gem√§ss Bild: 650 kg (¬±0.1 kg TS Verzehr pro 10 kg Differenz).</p>
                        </div>
                        
                        <div class="pt-2 border-t border-gray-100">
                            <p class="text-sm font-medium text-gray-700 mb-2">Rationsgestaltung & F√ºtterung</p>
                            <label class="flex items-center gap-2 mb-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="check_ration_silage" data-tsv="-1.0" class="text-green-600 rounded focus:ring-green-500">
                                <span class="text-sm text-gray-600">Hoher Silageanteil in Ration (> 75%) <span class="text-xs text-red-500 font-bold ml-1">-1.0 kg TS</span></span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="check_ration_hay" data-tsv="0.5" class="text-green-600 rounded focus:ring-green-500">
                                <span class="text-sm text-gray-600">F√ºtterungsbeginn mit Heu/Emd <span class="text-xs text-green-600 font-bold ml-1">+0.5 kg TS</span></span>
                            </label>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Futterverzehr (kg TS) manuell √ºberschreiben</label>
                            <input type="number" step="0.1" id="tsvOverride" placeholder="Automatisch berechnet" class="w-full p-2 border rounded focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Leer lassen f√ºr autom. Berechnung. Nutzen Sie den Tooltip oben f√ºr manuelle Anpassungen.</p>
                        </div>
                    </div>
                </div>

                <div id="step5-corrections" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hidden">
                    <label class="font-semibold text-gray-700 block mb-3">5. Abz√ºge & Korrekturen</label>
                    <div id="correction-inputs" class="space-y-2 text-sm"></div>
                </div>

                <div id="report-buttons" class="space-y-3 hidden">
                    <button id="savePdfButton" class="w-full py-3 bg-gray-700 text-white rounded font-bold hover:bg-gray-800 shadow">PDF Speichern</button>
                    
                    <div class="relative flex w-full shadow-md rounded">
                        <button id="saveCloudButton" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-l hover:bg-blue-700 transition-colors">
                            In Cloud speichern
                        </button>
                        <div class="w-px bg-blue-700"></div>
                        <button id="dropdownTrigger" class="px-4 bg-blue-600 text-white rounded-r hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <div id="saveDropdownMenu" class="absolute right-0 top-full mt-1 w-64 bg-white border border-gray-200 rounded-lg shadow-xl z-50 hidden">
                            <button id="saveJsonButton" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-50 flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Als JSON herunterladen
                            </button>
                        </div>
                    </div>
                </div>
                
                 <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <button id="data-accordion-toggle" class="w-full flex justify-between items-center p-4 font-semibold text-gray-700 text-left">
                        <span>Datenquelle</span>
                        <svg id="data-accordion-icon" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="data-accordion-content" class="hidden p-4 border-t border-gray-100 text-sm text-gray-600">
                        <p class="mb-2">Basierend auf AGROSCOPE 2017 Referenzdaten.</p>
                        <a href="https://graswachstum.ch/resources/agff-app-fodder-value/TABLES_Fourrages_Raufutter_AGROSCOPE2017_mit%20Farbskalen_v2025-11-05_zbma.xlsx" target="_blank" class="text-blue-600 underline hover:text-blue-800">Rohdaten-Tabelle (.xlsx) laden</a>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="stadiumModal" class="fixed inset-0 bg-black/50 hidden z-40 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center">
                <div>
                    <h3 id="stadiumModalTitle" class="font-bold text-lg">Stadium w√§hlen</h3>
                    <p id="stadiumModalSubtitle" class="text-xs text-gray-500"></p>
                </div>
                <button id="closeStadiumModal" class="text-gray-400 text-2xl">&times;</button>
            </div>
            
            <div class="p-4 overflow-y-auto">
                <div id="folgeHinweisContainer" class="mb-3"></div>
                
                <div id="stadiumHelpContent" class="hidden mb-4 border rounded p-2 bg-gray-50">
                    <p class="text-sm mb-2 font-semibold">Referenzbilder (Klicken zum Vergr√∂√üern):</p>
                    <div class="grid grid-cols-2 gap-2">
                         <figure><img src="https://graswachstum.ch/resources/agff-app-fodder-value/knaulgras.webp" class="rounded border cursor-zoom-in"><figcaption class="text-[10px] text-center">Knaulgras</figcaption></figure>
                         <figure><img src="https://graswachstum.ch/resources/agff-app-fodder-value/rotklee.webp" class="rounded border cursor-zoom-in"><figcaption class="text-[10px] text-center">Rotklee</figcaption></figure>
                    </div>
                </div>
                <button id="toggleStadiumHelp" class="text-blue-600 text-sm underline mb-2 block">Bilder & Hilfe anzeigen</button>

                <div id="stadium-options" class="space-y-2"></div>
            </div>
        </div>
    </div>
    
    <div id="imageLightbox" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-2 cursor-zoom-out">
        <img id="lightboxImage" class="max-w-full max-h-full rounded shadow-2xl">
    </div>

</body>
</html>